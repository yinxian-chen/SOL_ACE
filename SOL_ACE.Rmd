---
title: "ACEs and EAA"
author: "Yinxian Chen"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(tidyverse)
library(nlme)
library(clubSandwich)
#install.packages("devtools")
#devtools::install_github("kupietz/kableExtra")
library(kableExtra)
library(knitr)
library(mice)
library(miceadds)
library(readxl)
library(ggplot2)
library(haven)
```

```{r, include=F}
sol.pheno<-read.csv("pheno_final_983obs_withcells.csv")
sol.v1.eaa<-read.csv("HCHS_epigen_age_V1_updated_111623.csv")
sol.v2.eaa<-read.csv("HCHS_epigen_age_V2_updated_111623.csv")
sol.v1.dun<-read.csv("HCHS_DunedinPACE_Visit1_updated_103123.csv")
sol.v2.dun<-read.csv("HCHS_DunedinPACE_Visit2_updated_100523.csv")
sol.ac<-read.csv("subject_annotation_2017-05-24.csv")
sol.ace.items<-read.csv("ACE_items.csv")
correct_age<-read_xlsx("HCH035 V1 Age Corrections 30OCT23.xlsx")
smoke<-read_sas("/Volumes/rsphprojects-ts/ssuglia/SOL/data/Derived and Other Variables/tbea_inv4.sas7bdat")
```

### Data preparation

#### Exposure

  - The primary analysis focused on binary ACEs (**<4 ACEs vs. >=4 ACEs**), and **total ACEs score** (continuous)
  
  - In sensitivity analysis:
  
    - Three-level ACEs (0, 1-3, >=4 ACEs)
    
    - Individual items of ACE
  
#### Outcome

  - Only focused on **GrimAge** and **DunedinPACE**
  
  - For GrimAge, two indicators were used
  
    - GrimAge acceleration (**GrimAA**) (residuals)
    
    - GrimAge itself (**GrimAge**)
  
  - Only focus on subjects with two Epigenetic age measures

#### Covariates

  - Potential confounders
  
    - Baseline Age
    
    - Gender
    
    - Maternal education levels (< high school, high school, > high school)
    
    - Paternal education levels (< high school, high school, > high school)
    
  - Variables required in the longitudinal analysis
  
    - **Interval between two visits** (served as the time variable)
    
    - **ACEs\*Time** (To indicate the additional change in rate of EAA by ACEs)
    
  - For sensitivity analysis:
  
    - Cell types (NK, B, MO, GR, CD4, CD8)
    
    - Ancestry background (five principal components)
    
    - Parental separation as a covariate (use rest of the ACE items to calculate the score and dichotomize)
    
  - Secondary analysis (for potential EMM)
  
    - **Gender** (male vs. female)
    
    - **Nativity** (Born in the US vs. outside the US)
    
    - **Social support** (deviation from the mean ISEL score)
    
      - For better interpretation, the ISEL score was centered to the mean.
```{r, include=F}
### Code smoke variable
smoke$ID<-as.numeric(smoke$ID)

smoke<-smoke%>%mutate(CIGARETTE_USE = factor(ifelse(TBEA1==0, 1,
                                                    ifelse(TBEA3<3,2,3))))


```
    
    
```{r, include=F}
## Data preparation
### Only focus on the GrimAge
sol.v1.grim<-sol.v1.eaa%>%mutate(eaa_grim_v1=AgeAccelGrim,
                                 eage_grim_v1=DNAmGrimAgeBasedOnRealAge,
                                 age_v1=age)%>%
  select(c(ID,eaa_grim_v1,eage_grim_v1,age_v1))


sol.v2.grim<-sol.v2.eaa%>%mutate(eaa_grim_v2=AgeAccelGrim,
                                 eage_grim_v2=DNAmGrimAgeBasedOnRealAge,
                                 age_v2=age)%>%
  select(c(ID,eaa_grim_v2,eage_grim_v2,age_v2))

### Also include the Pace of EAA (DunedinPACE)
sol.v1.dun<-sol.v1.dun%>%mutate(dunedin_v1=DunedinPACE)%>%select(c(ID, dunedin_v1))
sol.v2.dun<-sol.v2.dun%>%mutate(dunedin_v2=DunedinPACE)%>%select(c(ID, dunedin_v2))
sol.ac.pc<-sol.ac%>%select(c(HCHS_ID,EV1,EV2,EV3,EV4,EV5))


#sol.pheno<-sol.pheno%>%mutate(AGE_correct=ifelse(AGE_correct-AGE< -1|AGE_correct-AGE> 1,AGE_correct, AGE))
#sol.pheno$AGE_V1_correct<-sol.pheno$AGE_correct


#### check age

#check_age<-merge(correct_age, sol.pheno[,c("ID","AGE_correct")], by = "ID")
#check_age<-check_age%>%mutate(age_diff = AGE_CORRECTED-AGE_correct)
#table(check_age$age_diff)

sol.pheno<-merge(correct_age, sol.pheno, by="ID", all.y = T)

sol.pheno<-sol.pheno%>%mutate(AGE_correct = ifelse(is.na(AGE_CORRECTED),AGE_correct,AGE_CORRECTED))
sol.pheno<-sol.pheno%>%mutate(AGE = AGE_correct)%>%select(-c(AGE_correct,AGE_V1_correct))

#sol.pheno[!is.na(sol.pheno$AGE_CORRECTED),c("ID","AGE","AGE_CORRECTED")]

sol.pheno$ID<-as.numeric(sol.pheno$ID)

#write.csv(sol.pheno,"/Volumes/rsphprojects-ts/ssuglia/SOL/data/Sarina_Epigen/02_phenodata/pheno_final_983obs_withcells.csv")
### ACEs items

#colnames(sol.ace.items)[1:2]<-c("ID","sub_id")

ace_item<-names(sol.ace.items)[54:63]

##Merge phenotype + epigenetic age variables
sol.list<-list(sol.pheno,sol.ace.items,sol.v1.grim,sol.v2.grim,sol.v1.dun,sol.v2.dun)
sol.phe.eaa<-sol.list%>%reduce(inner_join,by="ID")

# Has corrected
#outlier_ID<-sol.phe.eaa$ID[which((sol.phe.eaa$age_v2-sol.phe.eaa$AGE<3|sol.phe.eaa$age_v2-sol.phe.eaa$AGE>9))]

sol.phe.eaa<-sol.phe.eaa%>%mutate_at(vars(STEA11:STEA20), as.numeric)

sol.phe.eaa<-sol.phe.eaa%>%mutate_at(vars(SOEA1:SOEA12), function(x) {x-1})

sol.phe.eaa<-sol.phe.eaa%>%mutate_at(vars(c(SOEA1,SOEA2,SOEA7,SOEA8,SOEA11,SOEA12)), function(x) {3-x})

sosp_list<-names(sol.phe.eaa)[274:285]

sol.phe.eaa<-merge(sol.phe.eaa,smoke, by = "ID",all.x=T)

#sol.phe.eaa$ACE_TOT_ND<-rowSums(sol.phe.eaa[,c(403:407,409:412)],na.rm = T)

## Create a working dataset
cov_list<-c("ID","AGE","GENDER","PIEA22A","PIEA22B","PIEA23A","PIEA23B","US_BORN","YRSUS","EDUCATION_C2","INCOME_C3","BKGRD1_C7","NK_1","NK_2","B_1","B_2","MO_1","MO_2",
            "GR_1","GR_2","CD4_1","CD4_2","CD8_1","CD8_2","WEIGHT_NORM_OVERALL_EPIGEN","CIGARETTE_USE")

#cov_list_short<-c("ID","AGE","GENDER","PIEA22A","PIEA22B","PIEA23A","PIEA23B","US_BORN","YRSUS")

#cov_list_tv<-c("ID","NK_1","NK_2","B_1","B_2","MO_1","MO_2",
               #"GR_1","GR_2","CD4_1","CD4_2","CD8_1","CD8_2","WEIGHT_NORM_OVERALL_EPIGEN")

ace.1<-"ACE_TOT"

ace.2<-ace_item

#ace.3<-"ACE_TOT_ND"

eaa<-c("eaa_grim_v1","eaa_grim_v2","eage_grim_v1","eage_grim_v2","age_v1","age_v2","dunedin_v1","dunedin_v2")

sol.ana.1<-sol.phe.eaa[,c(cov_list,ace.1,ace.2,eaa,sosp_list)]

#table(sol.ana.1$PIEA22A)
#table(sol.ana.1$PIEA22B)
# 7TH GRADE 3RD GRADE 4TH GRADE MD MILITARY SCHOOL GED
#table(sol.ana.1$PIEA23A)
#table(sol.ana.1$PIEA23B)
# 4TH GRADE PHD 1ST GRADE 7TH GRADE MASTER DEGREE 3RD GRADE

### Recode the parental education levels

sol.ana.1<-sol.ana.1%>%mutate(fa_edu = ifelse(PIEA22A!=7,PIEA22A,
                                                     ifelse(PIEA22B=="3RD GRADE"|PIEA22B=="4TH GRADE",2,ifelse(PIEA22B=="7TH GRADE",3,
                                                                                                               ifelse(PIEA22B=="MD"|PIEA22B=="MILITARY SCHOOL",6,
                                                                                                                      ifelse(PIEA22B=="GED",4,NA))))))

sol.ana.1<-sol.ana.1%>%mutate(ma_edu = ifelse(PIEA23A!=7,PIEA23A,
                                                     ifelse(PIEA23B=="1ST GRADE"|PIEA23B=="3RD GRADE"|PIEA23B=="4TH GRADE",2,ifelse(PIEA23B=="7TH GRADE",3,
                                                                                                               ifelse(PIEA23B=="PHD"|PIEA23B=="MASTER DEGREE",6,NA)))))


sol.ana.1<-sol.ana.1%>%select(-c(PIEA22B,PIEA23B,PIEA22A,PIEA23A))%>%mutate(ma_edu_3c = factor(ifelse(ma_edu<3,1,
                                                       ifelse(ma_edu==3,2,3))),
                                    fa_edu_3c = factor(ifelse(fa_edu<3,1,
                                                       ifelse(fa_edu==3,2,3))))%>%select(-c(ma_edu,fa_edu))

sol.ana.1$age_v1<-sol.ana.1$AGE
#sol.ana.1<-sol.ana.1%>%select(-c(PIEA22A,PIEA23A))




#summary(sol.ana.1$ACE_TOT_ND)
```

### Missing data issue

  - **Over 10%** of subjects missed the data of parental education
  
    - Unlikely to be Missing Completely at Random (MCAR) because most missing value is not due to non-response but that **participants or their parents forgot**.
    
    - Therefore, it may depend on age, sex, current SES, ethnicity background...
    
  - Instead of just ignoring it, better to address it
  
    - Multiple imputation was applied in the primary analysis
    
    - Complete-case analysis was used as the sensitivity analysis

```{r, echo=F}
missing_rate<-do.call("cbind",lapply(sol.ana.1, function(x)
  rbind(sum(is.na(x)),100*sum(is.na(x)/dim(sol.ana.1)[1]))))
colnames(missing_rate)<-names(sol.ana.1)
rownames(missing_rate)<-c("N_miss","%_miss")
round(missing_rate, 2)



#missing_ace<-sol.ana.1%>%filter(is.na(ACE_TOT))%>%select(c(STEA11:STEA20))

#sol.ana.1<-sol.ana.1%>%filter(!is.na(ACE_TOT))

sol.ana.imp<-sol.ana.1%>%mutate(GENDER=factor(ifelse(GENDER=="M",0,1)))%>%select(-ACE_TOT)
```


### Multiple imputation

  - Impute all missing data in our dataset (including ACE items, parental education levels, and other covariates)
  
  - All covariates + additional SES variables (years in the US, current education attainment, income level, and ethnicity background) were involved in the imputation
  
  - To improve computability, only variables have > 0.1 correlation with the missing variables themselves or missingness of those variables were finally included in predictions.
  
  $$RE=(1+\frac{\lambda}{m})^{-1}$$
  
  - To achieve relative efficiency=0.95, five imputed datasets should be generated
  
    - Five replications + 20 iterations in each dataset were set up in the imputation
    
  - The imputed plots showed that the convergence is acceptable, meaning that we can move to the next step
  

```{r,echo=F}
predma<-quickpred(sol.ana.imp, exclude = c("ID","WEIGHT_NORM_OVERALL_EPIGEN","age_v1","age_v2","eage_grim_v1","eage_grim_v2",
                                           "eaa_grim_v1","eaa_grim_v2",
                                           "dunedin_v1","dunedin_v2"))
imp_1<-mice(sol.ana.imp, m=1, predictorMatrix = predma, print = F)
#summary(sol.ana.long.1)

#imp_1$predictorMatrix
#predma
predmethod<-imp_1$method
#predmethod
#summary(complete(imp_1))

lambda <- 1- sum(complete.cases(sol.ana.imp))/dim(sol.ana.imp)[1]
RE <- 0.95
lambda/(RE^(-1)-1) #5

set.seed(981119)

imp_5<-mice(sol.ana.imp, m=5, maxit = 20, predictorMatrix = predma, method = predmethod, print = F)

plot(imp_5)

imp_list<-datlist_create(imp_5)
```


```{r, include=F}
imp_list_new<-lapply(imp_list, function(data) {
  data$ACE_TOT<-rowSums(data[,names(data)%in%ace.2], na.rm = T)
  data$ACE_TOT_ND<-rowSums(data[,names(data)%in%ace.2[-6]], na.rm = T)
  data$ISEL_all<-rowSums(data[,names(data)%in%sosp_list], na.rm = T)
  data<-data%>%mutate(ace_c2 = ifelse(ACE_TOT<4,0,1),
                      ace_c3 = factor(ifelse(ACE_TOT==0,1,
                                      ifelse(ACE_TOT<4,2,3))),
                      ace_c2_ND = ifelse(ACE_TOT_ND<4,0,1),
                      ace_c3_ND = factor(ifelse(ACE_TOT_ND==0,1,
                                      ifelse(ACE_TOT<4,2,3))),
                      YRSUS_C2 = factor(ifelse(YRSUS<10,0,1)),
                      ISEL_C = ISEL_all-mean(ISEL_all))
  #res.1<-glm.ace.ub(data,"ace_c2","eaa_grim")
  data<-reshape(data = data,
                      varying = list(c("eaa_grim_v1","eaa_grim_v2"),c("eage_grim_v1","eage_grim_v2"),
                                     c("age_v1","age_v2"), c("dunedin_v1","dunedin_v2"),c("NK_1","NK_2"),
                                     c("B_1","B_2"),c("MO_1","MO_2"),c("GR_1","GR_2"),
                                     c("CD4_1","CD4_2"),c("CD8_1","CD8_2")),
                      v.names = c("eaa_grim","eage_grim","age_t","dunedin","NK","B","MO",
                                  "GR","CD4","CD8"),
                      idvar = "ID",
                      timevar = "time",
                      times = c(0,6),
                      direction = "long")
  data<-data[order(data$ID),]
  data<-data%>%mutate(age_arr_US = factor(ifelse(US_BORN==0,ifelse(AGE-YRSUS<18,2,3),1)),
                                    age_change = age_t-AGE)
  return(data)
}
  )
```


```{r, include=F}
### Convert into the long format for longitudinal analysis
sol.ana.long<-reshape(data = sol.ana.1,
                      varying = list(c("eaa_grim_v1","eaa_grim_v2"),c("eage_grim_v1","eage_grim_v2"),
                                     c("age_v1","age_v2"), c("dunedin_v1","dunedin_v2"),c("NK_1","NK_2"),
                                     c("B_1","B_2"),c("MO_1","MO_2"),c("GR_1","GR_2"),
                                     c("CD4_1","CD4_2"),c("CD8_1","CD8_2")),
                      v.names = c("eaa_grim","eage_grim","age_t","dunedin","NK","B","MO",
                                  "GR","CD4","CD8"),
                      idvar = "ID",
                      timevar = "time",
                      times = c(0,6),
                      direction = "long")
sol.ana.long<-sol.ana.long[order(sol.ana.long$ID),]
#sol.ana.long$t<-rep(c(1:2),nrow(sol.ana.1))
#sol.ana.long$time<-factor(sol.ana.long$time)
sol.ana.long<-sol.ana.long%>%mutate(#age_arr_US = factor(ifelse(US_BORN==0|is.na(US_BORN),ifelse(AGE-YRSUS<18,2,3),1)),
                                    age_change = age_t-AGE,
                                    GENDER = factor(ifelse(GENDER=="M",0,1)))%>%select(-c(age_t,time))

```



### Longitudinal analysis setup

  - Generalized linear mixed-effect models (GLMM) was applied here
  
  - Cluster-robust variance estimator was applied (everyone had different weight)
  
  - Interpretations for the core coeffcients:
  
    - **ACEs**: the difference in the first-visit EAA among those having more ACEs compared with those with less ACEs.
    
    - **Time**: the rate of change in EAA from first to second visit among those with less ACEs (reference group) 
    
    - **ACEs\*Time**: the difference in rate of change in EAA among those having more ACEs compared with those with less ACEs
    
    - **Note**: If the association is observed in "ACEs" but not in "ACE\*Time", that means the difference in EAA associated with ACEs is **CONSTANT** over time.

```{r,include=F}
glm.ace.ub<-function(data, exposure, outcome) {
  formula.1<-as.formula(paste(outcome, "~", exposure,"+ age_change + AGE + GENDER + fa_edu_3c + ma_edu_3c + age_change:", exposure))
  model.1<-lme(formula.1, 
               data = data,
               random = ~1+age_change|ID,
               weights = varFixed(~WEIGHT_NORM_OVERALL_EPIGEN),
               method = "REML",
               na.action = na.omit)
  #print(summary(model.cell))
  robust.1<-coef_test(model.1, vcov = "CR0", test = "z")
  return(robust.1)
}
```

  
```{r,include=F}
outcome_list<-c("eaa_grim","eage_grim","dunedin")
#rm(result.matrix)
result.matrix<-matrix(NA, nrow = 9, ncol = 5)
result.matrix[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))
for (i in 1:3) {
  pa<-lapply(imp_list_new, function(data){
  res<-glm.ace.ub(data,"ace_c2", outcome_list[i])
  return(res)
})

qhat<-lapply(pa, function(re){
  beta<-re$beta[c(2:3,10)]
  names(beta)<-c(">=4 ACEs","Time", ">=4 ACEs:Time")
  return(beta)
})

se<-lapply(pa, function(re){
  se<-re$SE[c(2:3,10)]
  names(se)<-c(">=4 ACEs","Time", ">=4 ACEs:Time")
  return(se)
})

pool.re <- pool_mi( qhat=qhat, se=se )

result.matrix[(3*i-2):(3*i),1]<-summary(pool.re)[["results"]]
result.matrix[(3*i-2):(3*i),2]<-summary(pool.re)[["p"]]
result.matrix[(3*i-2):(3*i),3]<-summary(pool.re)[["(lower"]]
result.matrix[(3*i-2):(3*i),4]<-summary(pool.re)[["upper)"]]

}
colnames(result.matrix)<-c("beta","p-value","lower","upper","outcome")

result.matrix<-as.data.frame(result.matrix)%>%mutate_at(vars(beta:upper), as.numeric)

```


```{r, include=F}
result.matrix.1<-matrix(NA, nrow = 9, ncol = 5)
result.matrix.1[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))

for (i in 1:3) {
  pa<-lapply(imp_list_new, function(data){
  res<-glm.ace.ub(data,"ACE_TOT", outcome_list[i])
  return(res)
})

qhat<-lapply(pa, function(re){
  beta<-re$beta[c(2:3,10)]
  names(beta)<-c("ACEs score","Time", "ACEs score:Time")
  return(beta)
})

se<-lapply(pa, function(re){
  se<-re$SE[c(2:3,10)]
  names(se)<-c("ACEs score","Time", "ACEs score:Time")
  return(se)
})

pool.re <- pool_mi( qhat=qhat, se=se )

result.matrix.1[(3*i-2):(3*i),1]<-summary(pool.re)[["results"]]
result.matrix.1[(3*i-2):(3*i),2]<-summary(pool.re)[["p"]]
result.matrix.1[(3*i-2):(3*i),3]<-summary(pool.re)[["(lower"]]
result.matrix.1[(3*i-2):(3*i),4]<-summary(pool.re)[["upper)"]]

}
colnames(result.matrix.1)<-c("beta","p-value","lower","upper","outcome")
result.matrix.1<-as.data.frame(result.matrix.1)%>%mutate_at(vars(beta:upper), as.numeric)
```

### Primary analysis

  - Both 4+ ACEs and ACEs score is positively associated with EAA at first visit (hold for all EAA indicators)
  
    - 4+ ACEs
    
      - GrimAA: `r round(result.matrix$beta[1],2)` (`r round(result.matrix$lower[1],2)`, `r round(result.matrix$upper[1],2)`)
      
      - GrimAge: `r format(round(result.matrix$beta[4],2),nsmall=2)` (`r round(result.matrix$lower[4],2)`, `r round(result.matrix$upper[4],2)`)
      
      - DunedinPACE: `r round(result.matrix$beta[7],2)` (`r format(round(result.matrix$lower[7],2),nsmall=2)`, `r round(result.matrix$upper[7],2)`)
      
    - ACEs score
    
      - GrimAA: `r round(result.matrix.1$beta[1],2)` (`r round(result.matrix.1$lower[1],2)`, `r round(result.matrix.1$upper[1],2)`)
      
      - GrimAge: `r round(result.matrix.1$beta[4],2)` (`r round(result.matrix.1$lower[4],2)`, `r round(result.matrix.1$upper[4],2)`)
      
      - DunedinPACE: `r round(result.matrix.1$beta[7],3)` (`r format(round(result.matrix.1$lower[7],3),nsmall=3)`, `r round(result.matrix.1$upper[7],3)`) 
  
  - However, no association with rate in EAA change over follow-up was observed


```{r, include=F}
result.matrix$variable<-factor(rep(c(1, 2, 3),3), levels = c(1,2,3), labels = c("4+ ACEs", "Time", "4+ ACEs*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
result.matrix$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))#c(rep("GrimAA",3),rep("GrimAge",3),rep("DunedinPACE",3))


ana.plot<- ggplot(data=result.matrix,
                          aes(x = variable, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable), size=2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between 4+ ACEs and EAA over Average Six-year Follow-up", col = "Variables")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())



```

```{r, echo=F}
ana.plot + theme(plot.title = element_text(size = 12))
```


```{r,include=F}
result.matrix.1$variable<-factor(rep(c(1, 2, 3),3), levels = c(1,2,3), labels = c("ACEs score", "Time", "ACEs score*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
result.matrix.1$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))#c(rep("GrimAA",3),rep("GrimAge",3),rep("DunedinPACE",3))


ana.plot.1<- ggplot(data=result.matrix.1,
                          aes(x = variable, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable), size=2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between ACEs Score and EAA over Average Six-year Follow-up", col = "Variables")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

```

```{r, echo=F}
ana.plot.1+ theme(plot.title = element_text(size = 12))
```


### Sensitivity analysis


```{r,include=F}
glm.ace.cell<-function(data, exposure, outcome) {
  formula.cell<-as.formula(paste(outcome, "~", exposure,"+ age_change + AGE + GENDER + fa_edu_3c + ma_edu_3c + NK + B + MO + GR + CD4 + CD8 + age_change:", exposure))
  model.cell<-lme(formula.cell, 
               data = data,
               random = ~1+age_change|ID,
               weights = varFixed(~WEIGHT_NORM_OVERALL_EPIGEN),
               method = "REML",
               na.action = na.omit)
  #print(summary(model.cell))
  robust.cell<-coef_test(model.cell, vcov = "CR0", test = "z")
  return(robust.cell)
}
```


```{r,include=F}
result.matrix.3<-matrix(NA, nrow = 9, ncol = 5)
result.matrix.3[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))

for (i in 1:3) {
  pa<-lapply(imp_list_new, function(data){
  res<-glm.ace.cell(data,"ace_c2", outcome_list[i])
  return(res)
})

qhat<-lapply(pa, function(re){
  beta<-re$beta[c(2:3,16)]
  names(beta)<-c(">=4 ACEs","Time", ">=4 ACEs:Time")
  return(beta)
})

se<-lapply(pa, function(re){
  se<-re$SE[c(2:3,16)]
  names(se)<-c(">=4 ACEs","Time", ">=4 ACEs:Time")
  return(se)
})

pool.re <- pool_mi( qhat=qhat, se=se )

result.matrix.3[(3*i-2):(3*i),1]<-summary(pool.re)[["results"]]
result.matrix.3[(3*i-2):(3*i),2]<-summary(pool.re)[["p"]]
result.matrix.3[(3*i-2):(3*i),3]<-summary(pool.re)[["(lower"]]
result.matrix.3[(3*i-2):(3*i),4]<-summary(pool.re)[["upper)"]]

}
colnames(result.matrix.3)<-c("beta","p-value","lower","upper","outcome")
result.matrix.3<-as.data.frame(result.matrix.3)%>%mutate_at(vars(beta:upper), as.numeric)
```



```{r,include=F}
result.matrix.4<-matrix(NA, nrow = 9, ncol = 5)
result.matrix.4[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))

for (i in 1:3) {
  pa<-lapply(imp_list_new, function(data){
  res<-glm.ace.cell(data,"ACE_TOT", outcome_list[i])
  return(res)
})

qhat<-lapply(pa, function(re){
  beta<-re$beta[c(2:3,16)]
  names(beta)<-c("ACEs score","Time", "ACEs score:Time")
  return(beta)
})

se<-lapply(pa, function(re){
  se<-re$SE[c(2:3,16)]
  names(se)<-c("ACEs score","Time", "ACEs score:Time")
  return(se)
})

pool.re <- pool_mi( qhat=qhat, se=se )

result.matrix.4[(3*i-2):(3*i),1]<-summary(pool.re)[["results"]]
result.matrix.4[(3*i-2):(3*i),2]<-summary(pool.re)[["p"]]
result.matrix.4[(3*i-2):(3*i),3]<-summary(pool.re)[["(lower"]]
result.matrix.4[(3*i-2):(3*i),4]<-summary(pool.re)[["upper)"]]

}
colnames(result.matrix.4)<-c("beta","p-value","lower","upper","outcome")
result.matrix.4<-as.data.frame(result.matrix.4)%>%mutate_at(vars(beta:upper), as.numeric)
```

#### Adjusted for cell types

  - Adjusting for cell types yielded consistent results (also slightly increase in precision)

```{r,echo=F}
result.matrix.3$variable<-factor(rep(c(1, 2, 3),3), levels = c(1,2,3), labels = c("4+ ACEs", "Time", "4+ ACEs*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
result.matrix.3$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

result.matrix.cell<-rbind(result.matrix,result.matrix.3)
result.matrix.cell$model<-factor(c(rep(1,9),rep(2,9)), levels = c(1,2), labels = c("Model 1", "Model 1 + Cell types"))
result.matrix.cell$position<-factor(c(rep(c(1,3,5),3),rep(c(2,4,6),3)))



ana.plot.cell<- ggplot(data=result.matrix.cell,
                          aes(x = position, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable, shape=model), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between 4+ ACEs and EAA over Average Six-year Follow-up", col = "Variables", shape = "Model")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.cell+ theme(plot.title = element_text(size = 12))
```

```{r, echo=F}
result.matrix.4$variable<-factor(rep(c(1, 2, 3),3), levels = c(1,2,3), labels = c("ACEs score", "Time", "ACEs score*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
result.matrix.4$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

result.matrix.cell.1<-rbind(result.matrix.1,result.matrix.4)
result.matrix.cell.1$model<-factor(c(rep(1,9),rep(2,9)), levels = c(1,2), labels = c("Model 1", "Model 1 + Cell types"))
result.matrix.cell.1$position<-factor(c(rep(c(1,3,5),3),rep(c(2,4,6),3)))



ana.plot.cell.1<- ggplot(data=result.matrix.cell.1,
                          aes(x = position, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable, shape=model), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between ACEs Score and EAA over Average Six-year Follow-up", col = "Variables", shape = "Model")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.cell.1+ theme(plot.title = element_text(size = 12))
```


#### Parental separate/divorce as the covariate

  - Pulling out parental separation/divorce showed consistent results

```{r,include=F}
### Parental separate as the covariate
glm.ace.nd<-function(data, exposure, outcome) {
  
  formula_1<-as.formula(paste(outcome, "~", exposure,"+ age_change + AGE + GENDER + fa_edu_3c + ma_edu_3c + STEA16 + age_change:", exposure))
  model.1<-lme(formula_1, 
               data = data,
               random = ~1+age_change|ID,
               weights = varFixed(~WEIGHT_NORM_OVERALL_EPIGEN),
               method = "REML",
               na.action = na.omit)
  #print(summary(model.1))
  robust.1<-coef_test(model.1, vcov = "CR0", test = "z")
  
  return(robust.1)
}
```


```{r,include=F}
result.matrix.5<-matrix(NA, nrow = 9, ncol = 5)
result.matrix.5[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))

for (i in 1:3) {
  pa<-lapply(imp_list_new, function(data){
  res<-glm.ace.nd(data,"ace_c2_ND", outcome_list[i])
  return(res)
})

qhat<-lapply(pa, function(re){
  beta<-re$beta[c(2:3,11)]
  names(beta)<-c(">=4 ACEs","Time", ">=4 ACEs:Time")
  return(beta)
})

se<-lapply(pa, function(re){
  se<-re$SE[c(2:3,11)]
  names(se)<-c(">=4 ACEs","Time", ">=4 ACEs:Time")
  return(se)
})

pool.re <- pool_mi( qhat=qhat, se=se )

result.matrix.5[(3*i-2):(3*i),1]<-summary(pool.re)[["results"]]
result.matrix.5[(3*i-2):(3*i),2]<-summary(pool.re)[["p"]]
result.matrix.5[(3*i-2):(3*i),3]<-summary(pool.re)[["(lower"]]
result.matrix.5[(3*i-2):(3*i),4]<-summary(pool.re)[["upper)"]]

}
colnames(result.matrix.5)<-c("beta","p-value","lower","upper","outcome")
result.matrix.5<-as.data.frame(result.matrix.5)%>%mutate_at(vars(beta:upper), as.numeric)
```

```{r, include=F}
result.matrix.6<-matrix(NA, nrow = 9, ncol = 5)
result.matrix.6[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))

for (i in 1:3) {
  pa<-lapply(imp_list_new, function(data){
  res<-glm.ace.nd(data,"ACE_TOT_ND", outcome_list[i])
  return(res)
})

qhat<-lapply(pa, function(re){
  beta<-re$beta[c(2:3,11)]
  names(beta)<-c("ACEs score","Time", "ACEs score:Time")
  return(beta)
})

se<-lapply(pa, function(re){
  se<-re$SE[c(2:3,11)]
  names(se)<-c("ACEs score","Time", "ACEs score:Time")
  return(se)
})

pool.re <- pool_mi( qhat=qhat, se=se )

result.matrix.6[(3*i-2):(3*i),1]<-summary(pool.re)[["results"]]
result.matrix.6[(3*i-2):(3*i),2]<-summary(pool.re)[["p"]]
result.matrix.6[(3*i-2):(3*i),3]<-summary(pool.re)[["(lower"]]
result.matrix.6[(3*i-2):(3*i),4]<-summary(pool.re)[["upper)"]]

}
colnames(result.matrix.6)<-c("beta","p-value","lower","upper","outcome")
result.matrix.6<-as.data.frame(result.matrix.6)%>%mutate_at(vars(beta:upper), as.numeric)
```


```{r, echo=F}
result.matrix.5$variable<-factor(rep(c(1, 2, 3),3), levels = c(1,2,3), labels = c("4+ ACEs", "Time", "4+ ACEs*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
result.matrix.5$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

result.matrix.nd<-rbind(result.matrix,result.matrix.5)
result.matrix.nd$model<-factor(c(rep(1,9),rep(2,9)), levels = c(1,2), labels = c("Parental separation as an ACE", "Parental separation as a covariate"))
result.matrix.nd$position<-factor(c(rep(c(1,3,5),3),rep(c(2,4,6),3)))



ana.plot.nd<- ggplot(data=result.matrix.nd,
                          aes(x = position, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable, shape = model), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between 4+ ACEs and EAA over Average Six-year Follow-up", col = "Variables", shape = "Model")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.nd+ theme(plot.title = element_text(size = 12))
```

```{r, echo=F}
result.matrix.6$variable<-factor(rep(c(1, 2, 3),3), levels = c(1,2,3), labels = c("ACEs score", "Time", "ACEs score*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
result.matrix.6$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

result.matrix.nd.1<-rbind(result.matrix.1,result.matrix.6)
result.matrix.nd.1$model<-factor(c(rep(1,9),rep(2,9)), levels = c(1,2), labels = c("Parental separation as an ACE", "Parental separation as a covariate"))
result.matrix.nd.1$position<-factor(c(rep(c(1,3,5),3),rep(c(2,4,6),3)))



ana.plot.nd.1<- ggplot(data=result.matrix.nd.1,
                          aes(x = position, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable, shape = model), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between ACEs Score and EAA over Average Six-year Follow-up", col = "Variables", shape = "Model")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.nd.1+ theme(plot.title = element_text(size = 12))
```



```{r,include=F}
result.matrix.2<-matrix(NA, nrow = 15, ncol = 5)
result.matrix.2[,5]<-c(rep("eaa_grim",5),rep("eage_grim",5),rep("dunedin",5))

for (i in 1:3) {
  pa<-lapply(imp_list_new, function(data){
  res<-glm.ace.ub(data,"ace_c3", outcome_list[i])
  return(res)
})

qhat<-lapply(pa, function(re){
  beta<-re$beta[c(2:4,11:12)]
  names(beta)<-c("1-3 ACEs",">=4 ACEs","Time", "1-3 ACEs:Time", ">=4 ACEs:Time")
  return(beta)
})

se<-lapply(pa, function(re){
  se<-re$SE[c(2:4,11:12)]
  names(se)<-c("1-3 ACEs",">=4 ACEs","Time", "1-3 ACEs:Time", ">=4 ACEs:Time")
  return(se)
})

pool.re <- pool_mi( qhat=qhat, se=se )

result.matrix.2[(5*i-4):(5*i),1]<-summary(pool.re)[["results"]]
result.matrix.2[(5*i-4):(5*i),2]<-summary(pool.re)[["p"]]
result.matrix.2[(5*i-4):(5*i),3]<-summary(pool.re)[["(lower"]]
result.matrix.2[(5*i-4):(5*i),4]<-summary(pool.re)[["upper)"]]

}
colnames(result.matrix.2)<-c("beta","p-value","lower","upper","outcome")
result.matrix.2<-as.data.frame(result.matrix.2)%>%mutate_at(vars(beta:upper), as.numeric)
```

#### Using three-level ACEs

  - 4+ ACEs was associated with increased EAA at the first visit compared with none
    
    - GrimAA: `r format(round(result.matrix.2$beta[2],2),nsmall=2)` (`r round(result.matrix.2$lower[2],2)`, `r round(result.matrix.2$upper[2],2)`)
      
    - GrimAge: `r format(round(result.matrix.2$beta[7],2),nsmall=2)` (`r round(result.matrix.2$lower[7],2)`, `r round(result.matrix.2$upper[7],2)`)
      
    - DunedinPACE: `r round(result.matrix.2$beta[12],2)` (`r format(round(result.matrix.2$lower[12],2),nsmall=2)`, `r round(result.matrix.2$upper[12],2)`)
  
  - 1-3 ACEs was also associated with increased EAA in two indicators compared with none with smaller magnitude
    
    - GrimAA: `r round(result.matrix.2$beta[1],2)` (`r round(result.matrix.2$lower[1],2)`, `r round(result.matrix.2$upper[1],2)`)
      
    - GrimAge: `r round(result.matrix.2$beta[6],2)` (`r round(result.matrix.2$lower[6],2)`, `r round(result.matrix.2$upper[6],2)`)
      
    - DunedinPACE: `r format(round(result.matrix.2$beta[11],3),nsmall=3)` (`r round(result.matrix.2$lower[11],3)`, `r round(result.matrix.2$upper[11],3)`) 
  
  - Again, no association was shown for rate in EAA change

```{r,echo=F}
result.matrix.2$variable<-factor(rep(c(1, 2, 3, 4, 5),3), levels = c(1,2,3,4,5), labels = c("1-3 ACEs", "4+ ACEs", "Time", "1-3 ACEs*Time", "4+ ACEs*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
result.matrix.2$outcome<-factor(c(rep(1,5),rep(2,5),rep(3,5)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

ana.plot.3c<- ggplot(data=result.matrix.2,
                          aes(x = variable, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable), size=2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between ACEs and EAA over Average Six-year Follow-up", col = "Variables")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.3c+ theme(plot.title = element_text(size = 12))
```


#### Assessment for ACE items

  - **Physical abuse** + **Sexual abuse** + **Emotional neglect** + **Parental separation/divorce** + **Witnessed intimate partner violence** + **Household substance abuse** + **Household mental illness** + **Incarcerated household members**
  
  - All above showed non-negligible effect sizes on EAA at the first visit (though not all of them were statistically significant)
  
  - Again, no association with rate in EAA change was observed 


```{r, include=F}
ace_specific<-lapply(ace.2, function(x){
  result.matrix.x<-matrix(NA, nrow = 9, ncol = 5)
  result.matrix.x[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))
  
  for (i in 1:3) {
    pa<-lapply(imp_list_new, function(data){
    res<-glm.ace.ub(data,x, outcome_list[i])
    return(res)
  })

  qhat<-lapply(pa, function(re){
    beta<-re$beta[c(2:3,10)]
    names(beta)<-c("ACE","Time", "ACE:Time")
    return(beta)
  })

  se<-lapply(pa, function(re){
    se<-re$SE[c(2:3,10)]
    names(se)<-c("ACE","Time", "ACE:Time")
    return(se)
  })

  pool.re <- pool_mi( qhat=qhat, se=se )

  result.matrix.x[(3*i-2):(3*i),1]<-summary(pool.re)[["results"]]
  result.matrix.x[(3*i-2):(3*i),2]<-summary(pool.re)[["p"]]
  result.matrix.x[(3*i-2):(3*i),3]<-summary(pool.re)[["(lower"]]
  result.matrix.x[(3*i-2):(3*i),4]<-summary(pool.re)[["upper)"]]

  }
  colnames(result.matrix.x)<-c("beta","p-value","lower","upper","outcome")
  result.matrix.x<-as.data.frame(result.matrix.x)%>%mutate_at(vars(beta:upper), as.numeric)
  return(result.matrix.x)
})
```

```{r, echo=F}
ace_specific_tot<-do.call("rbind", lapply(ace_specific, function(x) x))

ace_specific_tot$variable<-factor(rep(c(1, 2, 3),30), levels = c(1,2,3), labels = c("ACE", "Time", "ACE*Time"))

ace_specific_tot$type<-factor(c(rep(1,9),rep(2,9),rep(3,9), rep(4,9), rep(5,9), rep(6,9), rep(7,9), rep(8,9), rep(9,9), rep(10,9)), levels = c(1,2,3,4,5,6,7,8,9,10), labels = c("Emotional abuse","Physical abuse","Sexual abuse","Emotional neglect", "Physical neglect", "Parental seperation/divorce", "Witnessed intimate partner violence", "Household substance abuse", "Household mental illness", "Incarcerated household members"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
ace_specific_tot$outcome<-factor(rep(c(rep(1,3),rep(2,3),rep(3,3)),10), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))


ana.plot.specific<- ggplot(data=ace_specific_tot[ace_specific_tot$variable=="ACE",],
                          aes(x = type, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=type), size=2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between Individual ACE Items and EAA at First Visit", col = "Individual ACE items")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=type),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.specific + theme(plot.title = element_text(size = 12))

```

```{r, echo=F}
ana.plot.specific.1<- ggplot(data=ace_specific_tot[ace_specific_tot$variable=="ACE*Time",],
                          aes(x = type, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=type), size=2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between Individual ACE Items and Rate of EAA Change over Follow-up", col = "Individual ACE items")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=type),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.specific.1+ theme(plot.title = element_text(size = 11.5))
```


#### Adjust for ancestry

  - Only **774** subjects had the ancestry information
  
  - Association decreased for GrimAA and GrimAge but slightly increased for DunedinPACE
  
  - Precision decreased (sample size dropped)

```{r, include=F}
colnames(sol.ac.pc)[1]<-"ID"
#sol.ac.pc.long<-rbind(sol.ac.pc,sol.ac.pc)
#sol.ac.pc.long<-sol.ac.pc.long[order(sol.ac.pc.long$ID),]
#sol.ana.ac<-merge(sol.ana.1,sol.ac.pc, by = "ID")
imp_list_ac<-lapply(imp_list_new, function(data){
  data<-merge(data,sol.ac.pc, by = "ID")
  return(data)
})

```


```{r,include=F}
#### GLM
glm.ace.ac<-function(data, exposure, outcome) {
  formula.ac<-as.formula(paste(outcome, "~", exposure,"+ age_change + AGE + GENDER + fa_edu_3c + ma_edu_3c + EV1 + EV2 + EV3 + EV4 + EV5 + age_change:", exposure))
  model.ac<-lme(formula.ac, 
                  data = data,
                  random = ~1+age_change|ID,
                  weights = varFixed(~WEIGHT_NORM_OVERALL_EPIGEN),
                  method = "REML",
                  na.action = na.omit)
  #print(summary(model.ac))
  robust.ac<-coef_test(model.ac, vcov = "CR0", test = "z")
  return(robust.ac)
}
```


```{r,include=F}
ace_list<-c("ace_c2","ACE_TOT")

ace_ancestry<-lapply(ace_list, function(x){
  result.matrix.x<-matrix(NA, nrow = 9, ncol = 5)
  result.matrix.x[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))
  
  for (i in 1:3) {
    pa<-lapply(imp_list_ac, function(data){
    res<-glm.ace.ac(data,x, outcome_list[i])
    return(res)
  })

  qhat<-lapply(pa, function(re){
    beta<-re$beta[c(2:3,15)]
    names(beta)<-c("ACE","Time", "ACE:Time")
    return(beta)
  })

  se<-lapply(pa, function(re){
    se<-re$SE[c(2:3,15)]
    names(se)<-c("ACE","Time", "ACE:Time")
    return(se)
  })

  pool.re <- pool_mi( qhat=qhat, se=se )

  result.matrix.x[(3*i-2):(3*i),1]<-summary(pool.re)[["results"]]
  result.matrix.x[(3*i-2):(3*i),2]<-summary(pool.re)[["p"]]
  result.matrix.x[(3*i-2):(3*i),3]<-summary(pool.re)[["(lower"]]
  result.matrix.x[(3*i-2):(3*i),4]<-summary(pool.re)[["upper)"]]

  }
  colnames(result.matrix.x)<-c("beta","p-value","lower","upper","outcome")
  result.matrix.x<-as.data.frame(result.matrix.x)%>%mutate_at(vars(beta:upper), as.numeric)
  return(result.matrix.x)
})

```

```{r, echo=F}
ace_ancestry[[1]]$variable<-factor(rep(c(1, 2, 3),3), levels = c(1,2,3), labels = c("4+ ACEs", "Time", "4+ ACEs*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
ace_ancestry[[1]]$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

result.matrix.anc<-rbind(result.matrix,ace_ancestry[[1]])
result.matrix.anc$model<-factor(c(rep(1,9),rep(2,9)), levels = c(1,2), labels = c("Model 1", "Model 1 + Ancestry background"))
result.matrix.anc$position<-factor(c(rep(c(1,3,5),3),rep(c(2,4,6),3)))



ana.plot.anc<- ggplot(data=result.matrix.anc,
                          aes(x = position, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable, shape = model), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between 4+ ACEs and EAA over Average Six-year Follow-up", col = "Variables", shape = "Model")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.anc+ theme(plot.title = element_text(size = 12))
```

```{r,echo=F}
ace_ancestry[[2]]$variable<-factor(rep(c(1, 2, 3),3), levels = c(1,2,3), labels = c("ACEs score", "Time", "ACEs score*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
ace_ancestry[[2]]$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

result.matrix.anc.1<-rbind(result.matrix.1,ace_ancestry[[2]])
result.matrix.anc.1$model<-factor(c(rep(1,9),rep(2,9)), levels = c(1,2), labels = c("Model 1", "Model 1 + Ancestry background"))
result.matrix.anc.1$position<-factor(c(rep(c(1,3,5),3),rep(c(2,4,6),3)))



ana.plot.anc.1<- ggplot(data=result.matrix.anc.1,
                          aes(x = position, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable, shape = model), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between ACEs Score and EAA over Average Six-year Follow-up", col = "Variables", shape = "Model")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.anc.1+ theme(plot.title = element_text(size = 12))
```



```{r,include=F}
sol.ana.long.cca<-sol.ana.long[complete.cases(sol.ana.long[,c("ACE_TOT","fa_edu_3c","ma_edu_3c","GENDER","AGE")]),]
sol.ana.long.cca<-sol.ana.long.cca%>%mutate(ace_c2=ifelse(ACE_TOT<4,0,1))
sol.ana.long.cca<-sol.ana.long.cca%>%mutate(ma_ace_c2 = ace_c2*I(GENDER==0),
                                            fe_ace_c2 = ace_c2*I(GENDER==1),
                                            ma_ACE_TOT = ACE_TOT*I(GENDER==0),
                                            fe_ACE_TOT = ACE_TOT*I(GENDER==1))
#add position
sol.ana.long.cca$t<-rep(c(1,2),(nrow(sol.ana.long.cca))/2)


cca.list<-lapply(ace_list,function(x) {
   result.matrix.x<-matrix(NA, nrow = 9, ncol = 5)
   result.matrix.x[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))
   for (i in 1:3) {
     res<-glm.ace.ub(sol.ana.long.cca,x,outcome_list[i])
     res<-res[c(2:3,10),]
     result.matrix.x[(3*i-2):(3*i),1]<-res$beta
     result.matrix.x[(3*i-2):(3*i),2]<-res$p_z
     result.matrix.x[(3*i-2):(3*i),3]<-res$beta - 1.96*res$SE
     result.matrix.x[(3*i-2):(3*i),4]<-res$beta + 1.96*res$SE
   }
   colnames(result.matrix.x)<-c("beta","p-value","lower","upper","outcome")
   result.matrix.x<-as.data.frame(result.matrix.x)%>%mutate_at(vars(beta:upper), as.numeric)
   return(result.matrix.x)
})

```

#### Complete case analysis

  - There is evidence that not dealing with missing value may lead to **overestimated** results for EAA at the first visit.
  
    - 4+ ACEs
    
      - GrimAA: `r round(cca.list[[1]]$beta[1],2)` (`r round(cca.list[[1]]$lower[1],2)`, `r round(cca.list[[1]]$upper[1],2)`)
      
      - GrimAge: `r round(cca.list[[1]]$beta[4],2)` (`r round(cca.list[[1]]$lower[4],2)`, `r round(cca.list[[1]]$upper[4],2)`)
      
      - DunedinPACE: `r round(cca.list[[1]]$beta[7],2)` (`r format(round(cca.list[[1]]$lower[7],2), nsmall=2)`, `r round(cca.list[[1]]$upper[7],2)`)
      
    - ACEs score
    
      - GrimAA: `r format(round(cca.list[[2]]$beta[1],2),nsmall=2)` (`r round(cca.list[[2]]$lower[1],2)`, `r round(cca.list[[2]]$upper[1],2)`)
      
      - GrimAge: `r format(round(cca.list[[2]]$beta[4],2), nsmall=2)` (`r round(cca.list[[2]]$lower[4],2)`, `r round(cca.list[[2]]$upper[4],2)`)
      
      - DunedinPACE: `r round(cca.list[[2]]$beta[7],3)` (`r format(round(cca.list[[2]]$lower[7],3),nsmall=3)`, `r round(cca.list[[2]]$upper[7],3)`) 
  

```{r, echo=F}
cca.list[[1]]$variable<-factor(rep(c(1, 2, 3),3), levels = c(1,2,3), labels = c("4+ ACEs", "Time", "4+ ACEs*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
cca.list[[1]]$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

result.matrix.cca<-rbind(result.matrix,cca.list[[1]])
result.matrix.cca$model<-factor(c(rep(1,9),rep(2,9)), levels = c(1,2), labels = c("Multiple-imputation analysis", "Complete-case analysis"))
result.matrix.cca$position<-factor(c(rep(c(1,3,5),3),rep(c(2,4,6),3)))



ana.plot.cca<- ggplot(data=result.matrix.cca,
                          aes(x = position, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable, shape = model), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between 4+ ACEs and EAA over Average Six-year Follow-up", col = "Variables", shape = "Model")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.cca+ theme(plot.title = element_text(size = 12))
```

```{r, echo=F}
cca.list[[2]]$variable<-factor(rep(c(1, 2, 3),3), levels = c(1,2,3), labels = c("ACEs score", "Time", "ACEs score*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
cca.list[[2]]$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

result.matrix.cca.1<-rbind(result.matrix.1,cca.list[[2]])
result.matrix.cca.1$model<-factor(c(rep(1,9),rep(2,9)), levels = c(1,2), labels = c("Multiple-imputation analysis", "Complete-case analysis"))
result.matrix.cca.1$position<-factor(c(rep(c(1,3,5),3),rep(c(2,4,6),3)))



ana.plot.cca.1<- ggplot(data=result.matrix.cca.1,
                          aes(x = position, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable, shape = model), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between ACEs Score and EAA over Average Six-year Follow-up", col = "Variables", shape = "Model")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.cca.1+ theme(plot.title = element_text(size = 12))
```


### Potential effect modification

#### EMM by Gender

  - Difference was observed in gender-specific estimate for EAA at first visit but not in the rate of change in EAA
  
  - **However**, confidence interval was **highly overlapped**, which indicates less confidence in recognizing the EMM by gender
  
  - P-values for interaction were also large

```{r, include=F}
imp_list_gender<-lapply(imp_list_new, function(data) {
  data<-data%>%mutate(ma_ace_c2 = ace_c2*I(GENDER==0),
                      fe_ace_c2 = ace_c2*I(GENDER==1),
                      ma_ACE_TOT = ACE_TOT*I(GENDER==0),
                      fe_ACE_TOT = ACE_TOT*I(GENDER==1))
  return(data)
})
```

```{r, include=F}
glm.ace.sex<-function(data, exposure.1, exposure.2, outcome) {
  
  formula_1<-as.formula(paste(outcome, "~", exposure.1, "+", exposure.2, "+ age_change + AGE + GENDER + fa_edu_3c + ma_edu_3c + age_change:", exposure.1, "+ age_change:", exposure.2))
  model.1<-lme(formula_1, 
               data = data,
               random = ~1+age_change|ID,
               weights = varFixed(~WEIGHT_NORM_OVERALL_EPIGEN),
               method = "REML",
               na.action = na.omit)
  #print(summary(model.1))
  robust.1<-coef_test(model.1, vcov = "CR0", test = "z")
  
  return(robust.1)
}

glm.ace.int<-function(data, exposure, outcome) {
  
  formula_1<-as.formula(paste(outcome, "~", exposure, "+ age_change + AGE + GENDER + fa_edu_3c + ma_edu_3c + GENDER:", exposure, "+ age_change:", exposure, "+ age_change:GENDER:", exposure))
  model.1<-lme(formula_1, 
               data = data,
               random = ~1+age_change|ID,
               weights = varFixed(~WEIGHT_NORM_OVERALL_EPIGEN),
               method = "REML",
               na.action = na.omit)
  #print(summary(model.1))
  robust.1<-coef_test(model.1, vcov = "CR0", test = "z")
  
  return(robust.1)
}
```


```{r,include=F}
ace_indicator<-c("ma_ace_c2","fe_ace_c2","ma_ACE_TOT","fe_ACE_TOT")
ace_position<-c(1,2)

ace_gender<-lapply(ace_position, function(x){
  result.matrix.x<-matrix(NA, nrow = 15, ncol = 5)
  for (i in 1:3) {
    pa<-lapply(imp_list_gender, function(data){
    res<-glm.ace.sex(data,ace_indicator[2*x-1], ace_indicator[2*x], outcome_list[i])
    return(res)
  })

  qhat<-lapply(pa, function(re){
    beta<-re$beta[c(2:4,11:12)]
    names(beta)<-c("ACE (male)","ACE (female)","Time", "ACE:Time (male)","ACE:Time (female)")
    return(beta)
  })

  se<-lapply(pa, function(re){
    se<-re$SE[c(2:4,11:12)]
    names(se)<-c("ACE (male)","ACE (female)","Time", "ACE:Time (male)","ACE:Time (female)")
    return(se)
  })

  pool.re <- pool_mi( qhat=qhat, se=se )

  result.matrix.x[(5*i-4):(5*i),1]<-summary(pool.re)[["results"]]
  result.matrix.x[(5*i-4):(5*i),2]<-summary(pool.re)[["p"]]
  result.matrix.x[(5*i-4):(5*i),3]<-summary(pool.re)[["(lower"]]
  result.matrix.x[(5*i-4):(5*i),4]<-summary(pool.re)[["upper)"]]

  }
  colnames(result.matrix.x)<-c("beta","p-value","lower","upper","outcome")
  result.matrix.x<-as.data.frame(result.matrix.x)%>%mutate_at(vars(beta:upper), as.numeric)
  result.matrix.x[,5]<-factor(c(rep(1,5),rep(2,5),rep(3,5)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))
  return(result.matrix.x)
})
```

```{r,echo=F}
ace_gender[[1]]$variable<-factor(rep(c(1, 1, 2, 3, 3),3), levels = c(1,2,3), labels = c("4+ ACEs", "Time", "4+ ACEs*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
#cca.list[[1]]$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

result.matrix.gender<-ace_gender[[1]]%>%filter(variable!="Time")

#result.matrix.cca<-rbind(result.matrix,cca.list[[1]])
result.matrix.gender$gender<-factor(rep(c(1,2),6), levels = c(1,2), labels = c("Male", "Female"))
result.matrix.gender$position<-factor(c(rep(c(1,2,3,4),3)))



ana.plot.gender<- ggplot(data=result.matrix.gender,
                          aes(x = position, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable, shape = gender), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between 4+ ACEs and EAA over Average Six-year Follow-up by Gender", col = "Variables", shape = "Gender")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.gender+ theme(plot.title = element_text(size = 11.5))
```

```{r,echo=F}
ace_gender[[2]]$variable<-factor(rep(c(1, 1, 2, 3, 3),3), levels = c(1,2,3), labels = c("ACEs score", "Time", "ACEs score*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
#cca.list[[1]]$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

result.matrix.gender.1<-ace_gender[[2]]%>%filter(variable!="Time")

#result.matrix.cca<-rbind(result.matrix,cca.list[[1]])
result.matrix.gender.1$gender<-factor(rep(c(1,2),6), levels = c(1,2), labels = c("Male", "Female"))
result.matrix.gender.1$position<-factor(c(rep(c(1,2,3,4),3)))



ana.plot.gender.1<- ggplot(data=result.matrix.gender.1,
                          aes(x = position, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable, shape = gender), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between ACEs Score and EAA over Average Six-year Follow-up by Gender", col = "Variables", shape = "Gender")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.gender.1+ theme(plot.title = element_text(size = 11))
```

```{r,include=F}
ace_list<-c("ace_c2","ACE_TOT")

ace_int_gender<-lapply(ace_list, function(x){
  result.matrix.x<-matrix(NA, nrow = 6, ncol = 3)
  #result.matrix.x[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))
  for (i in 1:3) {
    pa<-lapply(imp_list_gender, function(data){
    res<-glm.ace.int(data,x, outcome_list[i])
    return(res)
  })

  qhat<-lapply(pa, function(re){
    beta<-re$beta[c(10,12)]
    names(beta)<-c("ACE:Time","ACE:Time:GENDER")
    return(beta)
  })

  se<-lapply(pa, function(re){
    se<-re$SE[c(10,12)]
    names(se)<-c("ACE:Time","ACE:Time:GENDER")
    return(se)
  })

  pool.re <- pool_mi( qhat=qhat, se=se )

  result.matrix.x[(2*i-1):(2*i),1]<-summary(pool.re)[["results"]]
  result.matrix.x[(2*i-1):(2*i),2]<-summary(pool.re)[["p"]]
  }
  colnames(result.matrix.x)<-c("beta","p-value","outcome")
  result.matrix.x<-as.data.frame(result.matrix.x)%>%mutate_at(vars(beta:"p-value"), as.numeric)
  result.matrix.x[,3]<-factor(c(rep(1,2),rep(2,2),rep(3,2)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))
  return(result.matrix.x)
})
```

```{r,echo=F}
ace_int_gender[[1]]$variable<-factor(rep(c(1,2),3), levels = c(1,2), labels = c("4+ ACEs:Gender","4+ ACEs:Gender:Time"))

ace_int_gender[[2]]$variable<-factor(rep(c(1,2),3), levels = c(1,2), labels = c("ACEs score:Gender","ACEs score:Gender:Time"))

ace_int_gender[[1]]
ace_int_gender[[2]]

```


#### EMM by Nativity

  - Strong evidence showed that **nativity modified the association** of ACEs and EAA at the first visit
  
    - Those who **born in the US** were **more susceptible** to the increase in EAA at first visit associated with ACEs
    
    - The null results were shown for those born outside the US
    
    - P-values for interaction were also <0.05 (statistically significant EMM)
    
  - Still no evidence showed that nativity modified the rate in EAA change

```{r, include=F}
imp_list_US_born<-lapply(imp_list_new, function(data) {
  data<-data%>%mutate(nusb_ace_c2 = ace_c2*I(US_BORN==0),
                      usb_ace_c2 = ace_c2*I(US_BORN==1),
                      nusb_ACE_TOT = ACE_TOT*I(US_BORN==0),
                      usb_ACE_TOT = ACE_TOT*I(US_BORN==1))
  return(data)
})

imp_list_age_arr<-lapply(imp_list_new, function(data) {
  data<-data%>%mutate(usb_ACE_TOT = ACE_TOT*I(age_arr_US==1),
                      arrb18_ACE_TOT = ACE_TOT*I(age_arr_US==2),
                      arra18_ACE_TOT = ACE_TOT*I(age_arr_US==3))
  return(data)
})
```

```{r, include=F}
glm.ace.usb<-function(data, exposure.1, exposure.2, outcome) {
  
  formula_1<-as.formula(paste(outcome, "~", exposure.1, "+", exposure.2, "+ age_change + AGE + GENDER + US_BORN + fa_edu_3c + ma_edu_3c + age_change:", exposure.1, "+ age_change:", exposure.2))
  model.1<-lme(formula_1, 
               data = data,
               random = ~1+age_change|ID,
               weights = varFixed(~WEIGHT_NORM_OVERALL_EPIGEN),
               method = "REML",
               na.action = na.omit)
  #print(summary(model.1))
  robust.1<-coef_test(model.1, vcov = "CR0", test = "z")
  
  return(robust.1)
}

glm.ace.int.usb<-function(data, exposure, outcome) {
  
  formula_1<-as.formula(paste(outcome, "~", exposure, "+ age_change + AGE + GENDER + US_BORN + fa_edu_3c + ma_edu_3c + US_BORN:", exposure, "+ age_change:", exposure, "+ age_change:US_BORN:", exposure))
  model.1<-lme(formula_1, 
               data = data,
               random = ~1+age_change|ID,
               weights = varFixed(~WEIGHT_NORM_OVERALL_EPIGEN),
               method = "REML",
               na.action = na.omit)
  #print(summary(model.1))
  robust.1<-coef_test(model.1, vcov = "CR0", test = "z")
  
  return(robust.1)
}
```

```{r, include=F}
glm.ace.arr<-function(data, exposure.1, exposure.2, exposure.3, outcome) {
  
  formula_1<-as.formula(paste(outcome, "~", exposure.1, "+", exposure.2, "+", exposure.3, "+ age_change + AGE + GENDER + age_arr_US + fa_edu_3c + ma_edu_3c + age_change:", exposure.1, "+ age_change:", exposure.2, "+ age_change:", exposure.3))
  model.1<-lme(formula_1, 
               data = data,
               random = ~1+age_change|ID,
               weights = varFixed(~WEIGHT_NORM_OVERALL_EPIGEN),
               method = "REML",
               na.action = na.omit)
  #print(summary(model.1))
  robust.1<-coef_test(model.1, vcov = "CR0", test = "z")
  
  return(robust.1)
}

glm.ace.int.arr<-function(data, exposure, outcome) {
  
  formula_1<-as.formula(paste(outcome, "~", exposure, "+ age_change + AGE + GENDER + age_arr_US + fa_edu_3c + ma_edu_3c + age_arr_US:", exposure, "+ age_change:", exposure, "+ age_change:age_arr_US:", exposure))
  model.1<-lme(formula_1, 
               data = data,
               random = ~1+age_change|ID,
               weights = varFixed(~WEIGHT_NORM_OVERALL_EPIGEN),
               method = "REML",
               na.action = na.omit)
  #print(summary(model.1))
  robust.1<-coef_test(model.1, vcov = "CR0", test = "z")
  
  return(robust.1)
}
```

```{r, include=F}
ace_indicator_1<-c("nusb_ace_c2","usb_ace_c2","nusb_ACE_TOT","usb_ACE_TOT")
ace_position<-c(1,2)

ace_usborn<-lapply(ace_position, function(x){
  result.matrix.x<-matrix(NA, nrow = 15, ncol = 5)
  for (i in 1:3) {
    pa<-lapply(imp_list_US_born, function(data){
    res<-glm.ace.usb(data,ace_indicator_1[2*x-1], ace_indicator_1[2*x], outcome_list[i])
    return(res)
  })

  qhat<-lapply(pa, function(re){
    beta<-re$beta[c(2:4,12:13)]
    names(beta)<-c("ACE (non-US-born)","ACE (US-born)","Time", "ACE:Time (non-US-born)","ACE:Time (US-born)")
    return(beta)
  })

  se<-lapply(pa, function(re){
    se<-re$SE[c(2:4,12:13)]
    names(se)<-c("ACE (non-US-born)","ACE (US-born)","Time", "ACE:Time (non-US-born)","ACE:Time (US-born)")
    return(se)
  })

  pool.re <- pool_mi( qhat=qhat, se=se )

  result.matrix.x[(5*i-4):(5*i),1]<-summary(pool.re)[["results"]]
  result.matrix.x[(5*i-4):(5*i),2]<-summary(pool.re)[["p"]]
  result.matrix.x[(5*i-4):(5*i),3]<-summary(pool.re)[["(lower"]]
  result.matrix.x[(5*i-4):(5*i),4]<-summary(pool.re)[["upper)"]]

  }
  colnames(result.matrix.x)<-c("beta","p-value","lower","upper","outcome")
  result.matrix.x<-as.data.frame(result.matrix.x)%>%mutate_at(vars(beta:upper), as.numeric)
  result.matrix.x[,5]<-factor(c(rep(1,5),rep(2,5),rep(3,5)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))
  return(result.matrix.x)
})
```

```{r, echo=F}
ace_usborn[[1]]$variable<-factor(rep(c(1, 1, 2, 3, 3),3), levels = c(1,2,3), labels = c("4+ ACEs", "Time", "4+ ACEs*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
#cca.list[[1]]$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

result.matrix.usb<-ace_usborn[[1]]%>%filter(variable!="Time")

#result.matrix.cca<-rbind(result.matrix,cca.list[[1]])
result.matrix.usb$US_BORN<-factor(rep(c(1,2),6), levels = c(1,2), labels = c("Non-US-born", "US-born"))
result.matrix.usb$position<-factor(c(rep(c(1,2,3,4),3)))



ana.plot.usb<- ggplot(data=result.matrix.usb,
                          aes(x = position, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable, shape = US_BORN), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between 4+ ACEs and EAA over Average Six-year Follow-up by Nativity", col = "Variables", shape = "Nativity")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.usb+ theme(plot.title = element_text(size = 11))
```

```{r, echo=F}
ace_usborn[[2]]$variable<-factor(rep(c(1, 1, 2, 3, 3),3), levels = c(1,2,3), labels = c("ACEs score", "Time", "ACEs score*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
#cca.list[[1]]$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

result.matrix.usb.1<-ace_usborn[[2]]%>%filter(variable!="Time")

#result.matrix.cca<-rbind(result.matrix,cca.list[[1]])
result.matrix.usb.1$US_BORN<-factor(rep(c(1,2),6), levels = c(1,2), labels = c("Non-US-born", "US-born"))
result.matrix.usb.1$position<-factor(c(rep(c(1,2,3,4),3)))



ana.plot.usb.1<- ggplot(data=result.matrix.usb.1,
                          aes(x = position, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable, shape = US_BORN), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between ACEs Score and EAA over Average Six-year Follow-up by Nativity", col = "Variables", shape = "Nativity")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.usb.1+ theme(plot.title = element_text(size = 10.5))
```

```{r, include=F}
ace_list<-c("ace_c2","ACE_TOT")

ace_int_usb<-lapply(ace_list, function(x){
  result.matrix.x<-matrix(NA, nrow = 6, ncol = 3)
  #result.matrix.x[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))
  for (i in 1:3) {
    pa<-lapply(imp_list_US_born, function(data){
    res<-glm.ace.int.usb(data,x, outcome_list[i])
    return(res)
  })

  qhat<-lapply(pa, function(re){
    beta<-re$beta[c(11,13)]
    names(beta)<-c("ACE:US_BORN","ACE:Time:US_BORN")
    return(beta)
  })

  se<-lapply(pa, function(re){
    se<-re$SE[c(11,13)]
    names(se)<-c("ACE:US_BORN","ACE:Time:US_BORN")
    return(se)
  })

  pool.re <- pool_mi( qhat=qhat, se=se )

  result.matrix.x[(2*i-1):(2*i),1]<-summary(pool.re)[["results"]]
  result.matrix.x[(2*i-1):(2*i),2]<-summary(pool.re)[["p"]]
  }
  colnames(result.matrix.x)<-c("beta","p-value","outcome")
  result.matrix.x<-as.data.frame(result.matrix.x)%>%mutate_at(vars(beta:"p-value"), as.numeric)
  result.matrix.x[,3]<-factor(c(rep(1,2),rep(2,2),rep(3,2)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))
  return(result.matrix.x)
})
```

```{r, echo=F}
ace_int_usb[[1]]$variable<-factor(rep(c(1,2),3), levels = c(1,2), labels = c("4+ ACEs:US_BORN","4+ ACEs:US_BORN:Time"))

ace_int_usb[[2]]$variable<-factor(rep(c(1,2),3), levels = c(1,2), labels = c("ACEs score:US_BORN","ACEs score:US_BORN:Time"))

ace_int_usb[[1]]
ace_int_usb[[2]]

```

#### Account for time at arrival

  - Did not change the conclusion that nativity status modified the association (power slightly decreased leading to statistically insignificant results but the p-values were very close to the threshold)

```{r, include=F}
ace_indicator_2<-c("usb_ACE_TOT","arrb18_ACE_TOT","arra18_ACE_TOT")


result.matrix.7<-matrix(NA, nrow = 18, ncol = 5)
for (i in 1:3) {
    pa<-lapply(imp_list_age_arr, function(data){
    res<-glm.ace.arr(data,ace_indicator_2[1], ace_indicator_2[2], ace_indicator_2[3], outcome_list[i])
    return(res)
  })

  qhat<-lapply(pa, function(re){
    beta<-re$beta[c(2:4,14:16)]
    names(beta)<-c("ACE (US-born)","ACE (<18)","ACE (>18)","ACE:Time (US-born)",
                   "ACE:Time (<18)","ACE:Time (>18)")
    return(beta)
  })

  se<-lapply(pa, function(re){
    se<-re$SE[c(2:4,14:16)]
    names(se)<-c("ACE (US-born)","ACE (<18)","ACE (>18)","ACE:Time (US-born)",
                   "ACE:Time (<18)","ACE:Time (>18)")
    return(se)
  })

  pool.re <- pool_mi( qhat=qhat, se=se )

  result.matrix.7[(6*i-5):(6*i),1]<-summary(pool.re)[["results"]]
  result.matrix.7[(6*i-5):(6*i),2]<-summary(pool.re)[["p"]]
  result.matrix.7[(6*i-5):(6*i),3]<-summary(pool.re)[["(lower"]]
  result.matrix.7[(6*i-5):(6*i),4]<-summary(pool.re)[["upper)"]]
  }
colnames(result.matrix.7)<-c("beta","p-value","lower","upper","outcome")
result.matrix.7<-as.data.frame(result.matrix.7)%>%mutate_at(vars(beta:upper), as.numeric)
result.matrix.7[,5]<-factor(c(rep(1,6),rep(2,6),rep(3,6)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

```

```{r, echo=F}
result.matrix.7$variable<-factor(rep(c(1, 1, 1, 2, 2, 2),3), levels = c(1,2), labels = c("ACEs score","ACEs score*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
#cca.list[[1]]$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

#result.matrix.cca<-rbind(result.matrix,cca.list[[1]])
result.matrix.7$arr<-factor(rep(c(1,2,3),6), levels = c(1,2,3), labels = c("US-born", "Arrived as a child","Arrived as an adult"))
result.matrix.7$position<-factor(c(rep(c(1,2,3,4,5,6),3)))



ana.plot.arr<- ggplot(data=result.matrix.7,
                          aes(x = position, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable, shape = arr), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between ACEs Score and EAA over Average Six-year Follow-up by Nativity Status", col = "Variables", shape = "Nativity status")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.arr+ theme(plot.title = element_text(size = 10.5))
```

```{r, include=F}
result.matrix.8<-matrix(NA, nrow = 12, ncol = 3)
  #result.matrix.x[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))
for (i in 1:3) {
    pa<-lapply(imp_list_age_arr, function(data){
    res<-glm.ace.int.arr(data,"ACE_TOT", outcome_list[i])
    return(res)
  })

  qhat<-lapply(pa, function(re){
    beta<-re$beta[c(12:13,15:16)]
    names(beta)<-c("ACE:<18","ACE:>=18","ACE:Time:<18","ACE:Time:>=18")
    return(beta)
  })

  se<-lapply(pa, function(re){
    se<-re$SE[c(12:13,15:16)]
    names(se)<-c("ACE:<18","ACE:>=18","ACE:Time:<18","ACE:Time:>=18")
    return(se)
  })

  pool.re <- pool_mi( qhat=qhat, se=se )

  result.matrix.8[(4*i-3):(4*i),1]<-summary(pool.re)[["results"]]
  result.matrix.8[(4*i-3):(4*i),2]<-summary(pool.re)[["p"]]
  }
colnames(result.matrix.8)<-c("beta","p-value","outcome")
result.matrix.8<-as.data.frame(result.matrix.8)%>%mutate_at(vars(beta:"p-value"), as.numeric)
result.matrix.8[,3]<-factor(c(rep(1,4),rep(2,4),rep(3,4)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

```

```{r, echo=F}
result.matrix.8$variable<-factor(rep(c(1,2,3,4),3), levels = c(1,2,3,4), labels =c("ACE:<18","ACE:>=18","ACE:Time:<18","ACE:Time:>=18"))


result.matrix.8

```



#### EMM by Social Support

  - Strong evidence showed that **social support levels modified the association** of ACEs and EAA at the first visit
  
    - Those who had **higher ISEL score** were **less susceptible** to the increase in EAA at first visit associated with ACEs
    
    - P-values are either <0.05 or small
    
  - Still no evidence showed that social support levels modified the rate in EAA change

```{r, include=F}
glm.ace.int.sp<-function(data, exposure, outcome) {
  
  formula_1<-as.formula(paste(outcome, "~", exposure, "+ age_change + AGE + GENDER + ISEL_C + fa_edu_3c + ma_edu_3c + ISEL_C:", exposure, "+ age_change:", exposure, "+ age_change:ISEL_C:", exposure))
  model.1<-lme(formula_1, 
               data = data,
               random = ~1+age_change|ID,
               weights = varFixed(~WEIGHT_NORM_OVERALL_EPIGEN),
               method = "REML",
               na.action = na.omit)
  #print(summary(model.1))
  robust.1<-coef_test(model.1, vcov = "CR0", test = "z")
  
  return(robust.1)
}
```


```{r, include=F}
ace_list<-c("ace_c2","ACE_TOT")

ace_int_sp<-lapply(ace_list, function(x){
  result.matrix.x<-matrix(NA, nrow = 9, ncol = 5)
  #result.matrix.x[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))
  for (i in 1:3) {
    pa<-lapply(imp_list_new, function(data){
    res<-glm.ace.int.sp(data,x, outcome_list[i])
    return(res)
  })

  qhat<-lapply(pa, function(re){
    beta<-re$beta[c(2,11,13)]
    names(beta)<-c("ACE","ACE:ISEL_C","ACE:Time:ISEL_C")
    return(beta)
  })

  se<-lapply(pa, function(re){
    se<-re$SE[c(2,11,13)]
    names(se)<-c("ACE","ACE:ISEL_C","ACE:Time:ISEL_C")
    return(se)
  })

  pool.re <- pool_mi( qhat=qhat, se=se )

  result.matrix.x[(3*i-2):(3*i),1]<-summary(pool.re)[["results"]]
  result.matrix.x[(3*i-2):(3*i),2]<-summary(pool.re)[["p"]]
  result.matrix.x[(3*i-2):(3*i),3]<-summary(pool.re)[["(lower"]]
  result.matrix.x[(3*i-2):(3*i),4]<-summary(pool.re)[["upper)"]]
  }
  colnames(result.matrix.x)<-c("beta","p-value","lower","upper","outcome")
  result.matrix.x<-as.data.frame(result.matrix.x)%>%mutate_at(vars(beta:upper), as.numeric)
  result.matrix.x[,5]<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))
  return(result.matrix.x)
})
```


```{r, echo=F}
ace_int_sp[[1]]$variable<-factor(rep(c(1, 2, 3),3), levels = c(1,2,3), labels = c("4+ ACEs", "4+ ACEs*ISEL score", "4+ ACEs*Time*ISEL score"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
#cca.list[[1]]$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

result.matrix.sp<-ace_int_sp[[1]]

#result.matrix.cca<-rbind(result.matrix,cca.list[[1]])
#result.matrix.sp$ISEL<-factor(rep(c(1,2),6), levels = c(1,2), labels = c("Non-US-born", "US-born"))
#result.matrix.usb$position<-factor(c(rep(c(1,2,3,4),3)))



ana.plot.sp<- ggplot(data=result.matrix.sp,
                          aes(x = variable, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between 4+ ACEs and EAA over Average Six-year Follow-up Modified by ISEL Score", col = "Variables")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.sp+ theme(plot.title = element_text(size = 10))
```

```{r, echo=F}
ace_int_sp[[2]]$variable<-factor(rep(c(1, 2, 3),3), levels = c(1,2,3), labels = c("ACEs score", "ACEs score*ISEL score", "ACEs score*Time*ISEL score"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
#cca.list[[1]]$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

result.matrix.sp.1<-ace_int_sp[[2]]

#result.matrix.cca<-rbind(result.matrix,cca.list[[1]])
#result.matrix.sp$ISEL<-factor(rep(c(1,2),6), levels = c(1,2), labels = c("Non-US-born", "US-born"))
#result.matrix.usb$position<-factor(c(rep(c(1,2,3,4),3)))



ana.plot.sp.1<- ggplot(data=result.matrix.sp.1,
                          aes(x = variable, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between ACEs Score and EAA over Average Six-year Follow-up Modified by ISEL Score", col = "Variables")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.sp.1+ theme(plot.title = element_text(size = 9.5))

```


```{r, echo=F}
ace_int_sp[[1]][,c(1:2,5:6)]
ace_int_sp[[2]][,c(1:2,5:6)]

```

### Checking the role of smoking

  - Smoking fully explained the association between ACEs and EAA
  
  - However, since we have found nativity status modified the association, we need to check if it would still hold after accounting for the EMM by nativity status

```{r,include=F}
glm.ace.smk<-function(data, exposure, outcome) {
  formula.smk<-as.formula(paste(outcome, "~", exposure,"+ age_change + AGE + GENDER + fa_edu_3c + ma_edu_3c + CIGARETTE_USE + age_change:", exposure))
  model.smk<-lme(formula.smk, 
               data = data,
               random = ~1+age_change|ID,
               weights = varFixed(~WEIGHT_NORM_OVERALL_EPIGEN),
               method = "REML",
               na.action = na.omit)
  #print(summary(model.cell))
  robust.smk<-coef_test(model.smk, vcov = "CR0", test = "z")
  return(robust.smk)
}
```


```{r,include=F}
result.matrix.10<-matrix(NA, nrow = 9, ncol = 5)
result.matrix.10[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))

for (i in 1:3) {
  pa<-lapply(imp_list_new, function(data){
  res<-glm.ace.smk(data,"ACE_TOT", outcome_list[i])
  return(res)
})

qhat<-lapply(pa, function(re){
  beta<-re$beta[c(2:3,12)]
  names(beta)<-c("ACEs score","Time", "ACEs score:Time")
  return(beta)
})

se<-lapply(pa, function(re){
  se<-re$SE[c(2:3,12)]
  names(se)<-c("ACEs score","Time", "ACEs score:Time")
  return(se)
})

pool.re <- pool_mi( qhat=qhat, se=se )

result.matrix.10[(3*i-2):(3*i),1]<-summary(pool.re)[["results"]]
result.matrix.10[(3*i-2):(3*i),2]<-summary(pool.re)[["p"]]
result.matrix.10[(3*i-2):(3*i),3]<-summary(pool.re)[["(lower"]]
result.matrix.10[(3*i-2):(3*i),4]<-summary(pool.re)[["upper)"]]

}
colnames(result.matrix.10)<-c("beta","p-value","lower","upper","outcome")
result.matrix.10<-as.data.frame(result.matrix.10)%>%mutate_at(vars(beta:upper), as.numeric)
```

```{r,echo=F}
result.matrix.10$variable<-factor(rep(c(1, 2, 3),3), levels = c(1,2,3), labels = c("ACEs score", "Time", "ACEs score*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
result.matrix.10$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

result.matrix.smk<-rbind(result.matrix.1,result.matrix.10)
result.matrix.smk$model<-factor(c(rep(1,9),rep(2,9)), levels = c(1,2), labels = c("Model 1", "Model 1 + Smoking status"))
result.matrix.smk$position<-factor(c(rep(c(1,3,5),3),rep(c(2,4,6),3)))



ana.plot.smk<- ggplot(data=result.matrix.smk,
                          aes(x = position, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable, shape=model), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between 4+ ACEs and EAA over Average Six-year Follow-up", col = "Variables", shape = "Model")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.smk+ theme(plot.title = element_text(size = 12))
```
#### Check if smoking fully explained the association across nativity status

  - Smoking did not fully explained the association among US-born individuals (the association was attenuated but remained robust)
  
  - Smoking attenuated (and even switched over) the association among non-US-born subjects, although the orignal association could be considered null
  
```{r, include=F}
glm.ace.arr.smk<-function(data, exposure.1, exposure.2, exposure.3, outcome) {
  
  formula_1<-as.formula(paste(outcome, "~", exposure.1, "+", exposure.2, "+", exposure.3, "+ age_change + AGE + GENDER + age_arr_US + CIGARETTE_USE + fa_edu_3c + ma_edu_3c + age_change:", exposure.1, "+ age_change:", exposure.2, "+ age_change:", exposure.3))
  model.1<-lme(formula_1, 
               data = data,
               random = ~1+age_change|ID,
               weights = varFixed(~WEIGHT_NORM_OVERALL_EPIGEN),
               method = "REML",
               na.action = na.omit)
  #print(summary(model.1))
  robust.1<-coef_test(model.1, vcov = "CR0", test = "z")
  
  return(robust.1)
}

glm.ace.int.arr.smk<-function(data, exposure, outcome) {
  
  formula_1<-as.formula(paste(outcome, "~", exposure, "+ age_change + AGE + GENDER + age_arr_US + fa_edu_3c + ma_edu_3c + CIGARETTE_USE + age_arr_US:", exposure, "+ age_change:", exposure, "+ age_change:age_arr_US:", exposure))
  model.1<-lme(formula_1, 
               data = data,
               random = ~1+age_change|ID,
               weights = varFixed(~WEIGHT_NORM_OVERALL_EPIGEN),
               method = "REML",
               na.action = na.omit)
  #print(summary(model.1))
  robust.1<-coef_test(model.1, vcov = "CR0", test = "z")
  
  return(robust.1)
}
```

  
```{r, include=F}
ace_indicator_2<-c("usb_ACE_TOT","arrb18_ACE_TOT","arra18_ACE_TOT")


result.matrix.11<-matrix(NA, nrow = 18, ncol = 5)
for (i in 1:3) {
    pa<-lapply(imp_list_age_arr, function(data){
    res<-glm.ace.arr.smk(data,ace_indicator_2[1], ace_indicator_2[2], ace_indicator_2[3], outcome_list[i])
    return(res)
  })

  qhat<-lapply(pa, function(re){
    beta<-re$beta[c(2:4,16:18)]
    names(beta)<-c("ACE (US-born)","ACE (<18)","ACE (>18)","ACE:Time (US-born)",
                   "ACE:Time (<18)","ACE:Time (>18)")
    return(beta)
  })

  se<-lapply(pa, function(re){
    se<-re$SE[c(2:4,16:18)]
    names(se)<-c("ACE (US-born)","ACE (<18)","ACE (>18)","ACE:Time (US-born)",
                   "ACE:Time (<18)","ACE:Time (>18)")
    return(se)
  })

  pool.re <- pool_mi( qhat=qhat, se=se )

  result.matrix.11[(6*i-5):(6*i),1]<-summary(pool.re)[["results"]]
  result.matrix.11[(6*i-5):(6*i),2]<-summary(pool.re)[["p"]]
  result.matrix.11[(6*i-5):(6*i),3]<-summary(pool.re)[["(lower"]]
  result.matrix.11[(6*i-5):(6*i),4]<-summary(pool.re)[["upper)"]]
  }
colnames(result.matrix.11)<-c("beta","p-value","lower","upper","outcome")
result.matrix.11<-as.data.frame(result.matrix.11)%>%mutate_at(vars(beta:upper), as.numeric)
result.matrix.11[,5]<-factor(c(rep(1,6),rep(2,6),rep(3,6)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

```

```{r, echo=F}
result.matrix.11$variable<-factor(rep(c(1, 1, 1, 2, 2, 2),3), levels = c(1,2), labels = c("ACEs score","ACEs score*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
#cca.list[[1]]$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

#result.matrix.cca<-rbind(result.matrix,cca.list[[1]])
result.matrix.11$arr<-factor(rep(c(1,2,3),6), levels = c(1,2,3), labels = c("US-born", "Arrived as a child","Arrived as an adult"))
result.matrix.11$position<-factor(c(rep(c(1,2,3,4,5,6),3)))



ana.plot.arr.smk<- ggplot(data=result.matrix.11,
                          aes(x = position, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable, shape = arr), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between ACEs Score and EAA over Average Six-year Follow-up by Nativity Status", col = "Variables", shape = "Nativity status")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.arr.smk+ theme(plot.title = element_text(size = 10.5))
```

```{r, include=F}
result.matrix.12<-matrix(NA, nrow = 12, ncol = 3)
  #result.matrix.x[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))
for (i in 1:3) {
    pa<-lapply(imp_list_age_arr, function(data){
    res<-glm.ace.int.arr.smk(data,"ACE_TOT", outcome_list[i])
    return(res)
  })

  qhat<-lapply(pa, function(re){
    beta<-re$beta[c(14:15,17:18)]
    names(beta)<-c("ACE:<18","ACE:>=18","ACE:Time:<18","ACE:Time:>=18")
    return(beta)
  })

  se<-lapply(pa, function(re){
    se<-re$SE[c(14:15,17:18)]
    names(se)<-c("ACE:<18","ACE:>=18","ACE:Time:<18","ACE:Time:>=18")
    return(se)
  })

  pool.re <- pool_mi( qhat=qhat, se=se )

  result.matrix.12[(4*i-3):(4*i),1]<-summary(pool.re)[["results"]]
  result.matrix.12[(4*i-3):(4*i),2]<-summary(pool.re)[["p"]]
  }
colnames(result.matrix.12)<-c("beta","p-value","outcome")
result.matrix.12<-as.data.frame(result.matrix.12)%>%mutate_at(vars(beta:"p-value"), as.numeric)
result.matrix.12[,3]<-factor(c(rep(1,4),rep(2,4),rep(3,4)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

```

```{r, echo=F}
result.matrix.12$variable<-factor(rep(c(1,2,3,4),3), levels = c(1,2,3,4), labels =c("ACE:<18","ACE:>=18","ACE:Time:<18","ACE:Time:>=18"))


result.matrix.12
```



