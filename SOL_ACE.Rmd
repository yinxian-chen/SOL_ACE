---
title: "SOL_ACE"
author: "Yinxian Chen"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(tidyverse)
library(nlme)
library(clubSandwich)
#install.packages("devtools")
#devtools::install_github("kupietz/kableExtra")
library(kableExtra)
library(knitr)
library(mice)
library(miceadds)
library(readxl)
library(ggplot2)
```

```{r}
sol.pheno<-read.csv("pheno_final_983obs_withcells.csv")
sol.v1.eaa<-read.csv("HCHS_epigen_age_V1_updated_100523.csv")
sol.v2.eaa<-read.csv("HCHS_epigen_age_V2_updated_100523.csv")
sol.v1.dun<-read.csv("HCHS_DunedinPACE_Visit1_updated_100523.csv")
sol.v2.dun<-read.csv("HCHS_DunedinPACE_Visit2_updated_100523.csv")
sol.ac<-read.csv("subject_annotation_2017-05-24.csv")
sol.ace.items<-read.csv("ACE_items.csv")
correct_age<-read_xlsx("HCH035 V1 Age Corrections 30OCT23.xlsx")
```

### Data preparation

#### Exposure

  - The primary analysis focused on binary ACEs (<4 ACEs vs. >=4 ACEs), and total ACEs score (continuous)
  
  - In sensitivity analysis, also focused the three-level ACEs (0, 1-3, >=4 ACEs)
  
#### Outcome

  - Only focused on GrimAge and DunedinPACE
  
  - For GrimAge, two indicators were used
  
    - GrimAge acceleration (residuals)
    
    - GrimAge change 
  
  - Only focus on subjects with two Epigenetic age measures

#### Covariates

  - First set (adjusted in Model 1)
  
    - Baseline Age
    
    - Gender
    
    - Study center
    
    - Time variable (AGE_V2-AGE_V1)
    
    - ACEs*Time (To indicate the additional change in rate of EAA by ACEs)
  
  - Second set (further adjusted in Model 2)
  
    - Education attainment (less than high school vs. high school and above)
    
    - Age at arrival in the US (born in the US, arrived before 18y, arrived after 18y)
    
    - Hispanic/Latino background (Central American, Cuba, Dominican, Dominican, Puerto Rican, South American, Mixed/Other)
    
  - For sensitivity analysis:
  
    - Cell types (NK, B, MO, GR, CD4, CD8)
    
    - Ancestry background (five principal components)
    
**Additional information**: One subject's (ID: 1494646) AGE_V1 > AGE_V2. I have flipped the subject's age to the right position.
    
```{r, include=F}
## Data preparation
### Only focus on the GrimAge
sol.v1.grim<-sol.v1.eaa%>%mutate(eaa_grim_v1=AgeAccelGrim,
                                 eage_grim_v1=DNAmGrimAgeBasedOnRealAge,
                                 age_v1=age)%>%
  select(c(ID,eaa_grim_v1,eage_grim_v1,age_v1))


sol.v2.grim<-sol.v2.eaa%>%mutate(eaa_grim_v2=AgeAccelGrim,
                                 eage_grim_v2=DNAmGrimAgeBasedOnRealAge,
                                 age_v2=age)%>%
  select(c(ID,eaa_grim_v2,eage_grim_v2,age_v2))

### Also include the Pace of EAA (DunedinPACE)
sol.v1.dun<-sol.v1.dun%>%mutate(dunedin_v1=DunedinPACE)%>%select(c(ID, dunedin_v1))
sol.v2.dun<-sol.v2.dun%>%mutate(dunedin_v2=DunedinPACE)%>%select(c(ID, dunedin_v2))
sol.ac.pc<-sol.ac%>%select(c(HCHS_ID,EV1,EV2,EV3,EV4,EV5))


#sol.pheno<-sol.pheno%>%mutate(AGE_correct=ifelse(AGE_correct-AGE< -1|AGE_correct-AGE> 1,AGE_correct, AGE))
#sol.pheno$AGE_V1_correct<-sol.pheno$AGE_correct


#### check age

check_age<-merge(correct_age, sol.pheno[,c("ID","AGE_correct")], by = "ID")
check_age<-check_age%>%mutate(age_diff = AGE_CORRECTED-AGE_correct)
table(check_age$age_diff)

sol.pheno<-merge(correct_age, sol.pheno, by="ID", all.y = T)

sol.pheno<-sol.pheno%>%mutate(AGE_correct = ifelse(is.na(AGE_CORRECTED),AGE_correct,AGE_CORRECTED))
sol.pheno<-sol.pheno%>%mutate(AGE = AGE_correct)%>%select(-c(AGE_correct,AGE_V1_correct))

sol.pheno[!is.na(sol.pheno$AGE_CORRECTED),c("ID","AGE","AGE_CORRECTED")]

sol.pheno$ID<-as.numeric(sol.pheno$ID)

#write.csv(sol.pheno,"/Volumes/rsphprojects-ts/ssuglia/SOL/data/Sarina_Epigen/02_phenodata/pheno_final_983obs_withcells.csv")
### ACEs items

#colnames(sol.ace.items)[1:2]<-c("ID","sub_id")

ace_item<-names(sol.ace.items)[54:63]

##Merge phenotype + epigenetic age variables
sol.list<-list(sol.pheno,sol.ace.items,sol.v1.grim,sol.v2.grim,sol.v1.dun,sol.v2.dun)
sol.phe.eaa<-sol.list%>%reduce(inner_join,by="ID")

# Has corrected
#outlier_ID<-sol.phe.eaa$ID[which((sol.phe.eaa$age_v2-sol.phe.eaa$AGE<3|sol.phe.eaa$age_v2-sol.phe.eaa$AGE>9))]

sol.phe.eaa<-sol.phe.eaa%>%mutate_at(vars(STEA11:STEA20), as.numeric)

#sol.phe.eaa$ACE_TOT_ND<-rowSums(sol.phe.eaa[,c(403:407,409:412)],na.rm = T)

## Create a working dataset
cov_list<-c("ID","AGE","GENDER","PIEA22A","PIEA22B","PIEA23A","PIEA23B","US_BORN","YRSUS","EDUCATION_C2","INCOME_C3","BKGRD1_C7","NK_1","NK_2","B_1","B_2","MO_1","MO_2",
            "GR_1","GR_2","CD4_1","CD4_2","CD8_1","CD8_2","WEIGHT_NORM_OVERALL_EPIGEN")

#cov_list_short<-c("ID","AGE","GENDER","PIEA22A","PIEA22B","PIEA23A","PIEA23B","US_BORN","YRSUS")

#cov_list_tv<-c("ID","NK_1","NK_2","B_1","B_2","MO_1","MO_2",
               #"GR_1","GR_2","CD4_1","CD4_2","CD8_1","CD8_2","WEIGHT_NORM_OVERALL_EPIGEN")

ace.1<-"ACE_TOT"

ace.2<-ace_item

#ace.3<-"ACE_TOT_ND"

eaa<-c("eaa_grim_v1","eaa_grim_v2","eage_grim_v1","eage_grim_v2","age_v1","age_v2","dunedin_v1","dunedin_v2")

sol.ana.1<-sol.phe.eaa[,c(cov_list,ace.1,ace.2,eaa)]

#table(sol.ana.1$PIEA22A)
#table(sol.ana.1$PIEA22B)
# 7TH GRADE 3RD GRADE 4TH GRADE MD MILITARY SCHOOL GED
#table(sol.ana.1$PIEA23A)
#table(sol.ana.1$PIEA23B)
# 4TH GRADE PHD 1ST GRADE 7TH GRADE MASTER DEGREE 3RD GRADE

### Recode the parental education levels

sol.ana.1<-sol.ana.1%>%mutate(fa_edu = ifelse(PIEA22A!=7,PIEA22A,
                                                     ifelse(PIEA22B=="3RD GRADE"|PIEA22B=="4TH GRADE",2,ifelse(PIEA22B=="7TH GRADE",3,
                                                                                                               ifelse(PIEA22B=="MD"|PIEA22B=="MILITARY SCHOOL",6,
                                                                                                                      ifelse(PIEA22B=="GED",4,NA))))))

sol.ana.1<-sol.ana.1%>%mutate(ma_edu = ifelse(PIEA23A!=7,PIEA23A,
                                                     ifelse(PIEA23B=="1ST GRADE"|PIEA23B=="3RD GRADE"|PIEA23B=="4TH GRADE",2,ifelse(PIEA23B=="7TH GRADE",3,
                                                                                                               ifelse(PIEA23B=="PHD"|PIEA23B=="MASTER DEGREE",6,NA)))))


sol.ana.1<-sol.ana.1%>%select(-c(PIEA22B,PIEA23B,PIEA22A,PIEA23A))%>%mutate(ma_edu_3c = factor(ifelse(ma_edu<3,1,
                                                       ifelse(ma_edu==3,2,3))),
                                    fa_edu_3c = factor(ifelse(fa_edu<3,1,
                                                       ifelse(fa_edu==3,2,3))))%>%select(-c(ma_edu,fa_edu))

sol.ana.1$age_v1<-sol.ana.1$AGE
#sol.ana.1<-sol.ana.1%>%select(-c(PIEA22A,PIEA23A))


missing_rate<-do.call("cbind",lapply(sol.ana.1, function(x)
  rbind(sum(is.na(x)),100*sum(is.na(x)/dim(sol.ana.1)[1]))))
colnames(missing_rate)<-names(sol.ana.1)
round(missing_rate, 2)

missing_ace<-sol.ana.1%>%filter(is.na(ACE_TOT))%>%select(c(STEA11:STEA20))

#sol.ana.1<-sol.ana.1%>%filter(!is.na(ACE_TOT))


#summary(sol.ana.1$ACE_TOT_ND)
```






```{r, include=F}
### Convert into the long format for longitudinal analysis
sol.ana.long<-reshape(data = sol.ana.1,
                      varying = list(c("eaa_grim_v1","eaa_grim_v2"),c("eage_grim_v1","eage_grim_v2"),
                                     c("age_v1","age_v2"), c("dunedin_v1","dunedin_v2"),c("NK_1","NK_2"),
                                     c("B_1","B_2"),c("MO_1","MO_2"),c("GR_1","GR_2"),
                                     c("CD4_1","CD4_2"),c("CD8_1","CD8_2")),
                      v.names = c("eaa_grim","eage_grim","age_t","dunedin","NK","B","MO",
                                  "GR","CD4","CD8"),
                      idvar = "ID",
                      timevar = "time",
                      times = c(0,6),
                      direction = "long")
sol.ana.long<-sol.ana.long[order(sol.ana.long$ID),]
#sol.ana.long$t<-rep(c(1:2),nrow(sol.ana.1))
#sol.ana.long$time<-factor(sol.ana.long$time)
sol.ana.long<-sol.ana.long%>%mutate(#age_arr_US = factor(ifelse(US_BORN==0|is.na(US_BORN),ifelse(AGE-YRSUS<18,2,3),1)),
                                    age_change = age_t-AGE,
                                    GENDER = factor(ifelse(GENDER=="M",0,1)))%>%select(-c(age_t,time))

```

```{r, echo=F}
result.summary<-function(data, exposure, covar="normal") {
  
  exposure<-exposure
  covar<-covar
  
  if(exposure =="ace_c4"){
    gee.summary.1<-matrix(NA,nrow = 10, ncol = 4)
    for(i in c(1:10)) {
      indices<-c(2,3,4,10,11,2,3,4,19,20)
      if (i<=5) {
        gee.summary.1[i,1]<-data[[1]]$beta[indices[i]]
        gee.summary.1[i,2]<-data[[1]]$beta[indices[i]]-1.96*data[[1]]$SE[indices[i]]
        gee.summary.1[i,3]<-data[[1]]$beta[indices[i]]+1.96*data[[1]]$SE[indices[i]]
        gee.summary.1[i,4]<-data[[1]]$p_z[indices[i]]
      }
      
      else {
        gee.summary.1[i,1]<-data[[2]]$beta[indices[i]]
        gee.summary.1[i,2]<-data[[2]]$beta[indices[i]]-1.96*data[[2]]$SE[indices[i]]
        gee.summary.1[i,3]<-data[[2]]$beta[indices[i]]+1.96*data[[2]]$SE[indices[i]]
        gee.summary.1[i,4]<-data[[2]]$p_z[indices[i]]
      }
    }
    rownames(gee.summary.1)<-rep(c("1-3 ACEs",">=4 ACEs","Time","1-3 ACEs*Time",">=4 ACEs*Time"),2)
  }
  
  else{
    if(covar=="normal") {
      gee.summary.1<-matrix(NA,nrow = 6, ncol = 4)
      for (i in c(1:6)) {
        indices<-c(2,3,9,2,3,18)
        if (i<=3) {
          
          gee.summary.1[i,1]<-data[[1]]$beta[indices[i]]
          gee.summary.1[i,2]<-data[[1]]$beta[indices[i]]-1.96*data[[1]]$SE[indices[i]]
          gee.summary.1[i,3]<-data[[1]]$beta[indices[i]]+1.96*data[[1]]$SE[indices[i]]
          gee.summary.1[i,4]<-data[[1]]$p_z[indices[i]]
        }
        
        else {
          gee.summary.1[i,1]<-data[[2]]$beta[indices[i]]
          gee.summary.1[i,2]<-data[[2]]$beta[indices[i]]-1.96*data[[2]]$SE[indices[i]]
          gee.summary.1[i,3]<-data[[2]]$beta[indices[i]]+1.96*data[[2]]$SE[indices[i]]
          gee.summary.1[i,4]<-data[[2]]$p_z[indices[i]]
        }
      }
      
      if(exposure=="ace_c2"){
        rownames(gee.summary.1)<-rep(c(">=4 ACEs", "Time", ">=4 ACEs*Time"),2)
      }
      else {
        rownames(gee.summary.1)<-rep(c("ACEs total score", "Time", "ACEs total score*Time"),2)
      }
    }
    
    if(covar=="ancenstry") {
      gee.summary.1<-matrix(NA,nrow = 3, ncol = 4)
      for(i in c(1:3)) {
        indices<-c(2,3,23)
        gee.summary.1[i,1]<-data$beta[indices[i]]
        gee.summary.1[i,2]<-data$beta[indices[i]]-1.96*data$SE[indices[i]]
        gee.summary.1[i,3]<-data$beta[indices[i]]+1.96*data$SE[indices[i]]
        gee.summary.1[i,4]<-data$p_z[indices[i]]
      }
      if(exposure=="ace_c2"){
        rownames(gee.summary.1)<-c(">=4 ACEs", "Time", ">=4 ACEs*Time")
      }
      else {
        rownames(gee.summary.1)<-c("ACEs total score", "Time", "ACEs total score*Time")
      }
    }
    
    if(covar=="cell_type") {
      gee.summary.1<-matrix(NA,nrow = 3, ncol = 4)
      for(i in c(1:3)) {
        indices<-c(2,3,24)
        gee.summary.1[i,1]<-data$beta[indices[i]]
        gee.summary.1[i,2]<-data$beta[indices[i]]-1.96*data$SE[indices[i]]
        gee.summary.1[i,3]<-data$beta[indices[i]]+1.96*data$SE[indices[i]]
        gee.summary.1[i,4]<-data$p_z[indices[i]]
      }
      if(exposure=="ace_c2"){
        rownames(gee.summary.1)<-c(">=4 ACEs", "Time", ">=4 ACEs*Time")
      }
      else {
        rownames(gee.summary.1)<-c("ACEs total score", "Time", "ACEs total score*Time")
      }
    }
  }
  
  colnames(gee.summary.1)<-c("beta","ll","ul","p-value")
  return(gee.summary.1)
}
```

### Longitudinal analysis setup

  - Generalized estimating equations (GEE) and Generalized linear mixed-effect models (GLMM)
  
  - Each model can be weighted by the the sampling weight for each subject
  
  - Advantages to use the longitudinal analysis approach:
  
    - Can gain the estimates of associations in interest simultaneously:
    
      - Association between ACEs and the EAA at baseline
      
      - Association between ACEs and the rate of change in EAA from time 1 to time 2
      
    - More powerful than modeling two outcomes separately and can also have a consistent interpretation
    
  - Robust variance estimator (sandwish estimator) was used to account for the sampling weight

#### Imbalanced desgin

  - We can see that not all participants were measured the second epigenetic age after 6 years from the first visit
  
  - Also, there were some outliers with unreasonable interval between two visits
  
    - First visit (2008-2011) and Second visit (2014-2017)
    
      - So the range of the interval should be [2014-2011, 2017-2008] = [3, 9] years
  
    - I removed those out of this range in the analysis but will definitely add them back if necessary
  
  - The GEE cannot handle the imbalanced design in the longitudinal study
  
    - So only GLMM could be used here

```{r}
# Consistency between baseline age and age at first epigenetic age measurement
summary(sol.ana.1$age_v1-sol.ana.1$AGE)
# Interval between first and second measurement
table(sol.ana.1$age_v2-sol.ana.1$AGE)
# Subjects that had the interval <3 or >9
sol.ana.1$ID[which((sol.ana.1$age_v2-sol.ana.1$AGE<3|sol.ana.1$age_v2-sol.ana.1$AGE>9))]
outlier_ID<-sol.ana.1$ID[which((sol.ana.1$age_v2-sol.ana.1$AGE<3|sol.ana.1$age_v2-sol.ana.1$AGE>9))]

```

#### Create separate dataset for different ACEs indicators
```{r}
### Primary analysis (total score)
sol.ana.long.1<-sol.ana.long[,!names(sol.ana.long)%in%c(ace.1)]

### Sensitivity 1 (each type of ACE)

### Sensitivity 2 (parental separate as covariate)
```


### Test for multiple imputation analysis

```{r}
predma<-quickpred(sol.ana.long.1, exclude = c("ID","WEIGHT_NORM_OVERALL_EPIGEN"))
imp_1<-mice(sol.ana.long.1, m=1, predictorMatrix = predma, print = F)
#summary(sol.ana.long.1)

#imp_1$predictorMatrix
#predma
predmethod<-imp_1$method
#predmethod
#summary(complete(imp_1))

#lambda <- 1- sum(complete.cases(sol.ana.long.1))/dim(sol.ana.long.1)[1]
#RE <- 0.95
#lambda/(RE^(-1)-1) #5

set.seed(981119)

imp_5<-mice(sol.ana.long.1, m=5, maxit = 10, predictorMatrix = predma, method = predmethod, print = F)

plot(imp_5)

imp_list<-datlist_create(imp_5)

```
```{r}
### Unbalance design
glm.ace.ub<-function(data, exposure, outcome) {
  
  formula_1<-as.formula(paste(outcome, "~", exposure,"+ age_change + AGE + GENDER + fa_edu_3c + ma_edu_3c + age_change:", exposure))
  model.1<-lme(formula_1, 
               data = data,
               random = ~1+age_change|ID,
               weights = varFixed(~WEIGHT_NORM_OVERALL_EPIGEN),
               method = "REML",
               na.action = na.omit)
  #print(summary(model.1))
  robust.1<-coef_test(model.1, vcov = "CR0", test = "z")
  
  return(robust.1)
}
```

### Primary analysis

  - Although statistically insignificant in all Model 2 (adjusted for the proximal childhood SES)

    - Stronger evidence that two-level ACEs was associated with increased **DunedinPACE** at the first visit in in two models
  
    - Stronger evidence that total ACEs score was associated with increased **GrimAA** and **GrimAage** at the first visit in two models
  
  - Different reference group led to different results
  
    - We can see consistent results in the models using three-level ACEs with models using ACEs score
    
  - What consistent is, **no association** was seen in the rate of three EAA indicators (results shown in the ACE*time)
  
```{r}
imp_list_new<-lapply(imp_list, function(data) {
  data$ACE_TOT<-rowSums(data[,names(data)%in%ace.2], na.rm = T)
  data$ACE_TOT_ND<-rowSums(data[,names(data)%in%ace.2[-6]], na.rm = T)
  data<-data%>%mutate(ace_c2 = ifelse(ACE_TOT<4,0,1),
                      ace_c3 = factor(ifelse(ACE_TOT==0,1,
                                      ifelse(ACE_TOT<4,2,3))),
                      ace_c2_ND = ifelse(ACE_TOT_ND<4,0,1),
                      ace_c3_ND = factor(ifelse(ACE_TOT_ND==0,1,
                                      ifelse(ACE_TOT<4,2,3))))
  #res.1<-glm.ace.ub(data,"ace_c2","eaa_grim")
  return(data)
}
  )

```
  
```{r}
pa.1<-lapply(imp_list_new, function(data){
  res.1<-glm.ace.ub(data,"ace_c2","eaa_grim")
  return(res.1)
})

qhat<-lapply(pa.1, function(re){
  beta<-re$beta[c(2:3,10)]
  names(beta)<-c(">=4 ACEs","Time", ">=4 ACEs:Time")
  return(beta)
})

se<-lapply(pa.1, function(re){
  se<-re$SE[c(2:3,10)]
  names(se)<-c(">=4 ACEs","Time", ">=4 ACEs:Time")
  return(se)
})

pool.1 <- pool_mi( qhat=qhat, se=se )

summary(pool.1)
```
  
  
```{r}
pa.2<-lapply(imp_list_new, function(data){
  res.2<-glm.ace.ub(data,"ace_c2","eage_grim")
  return(res.2)
})

qhat<-lapply(pa.2, function(re){
  beta<-re$beta[c(2:3,10)]
  names(beta)<-c(">=4 ACEs","Time", ">=4 ACEs:Time")
  return(beta)
})

se<-lapply(pa.2, function(re){
  se<-re$SE[c(2:3,10)]
  names(se)<-c(">=4 ACEs","Time", ">=4 ACEs:Time")
  return(se)
})

pool.2 <- pool_mi( qhat=qhat, se=se )

summary(pool.2)
```
  
  
```{r}
pa.3<-lapply(imp_list_new, function(data){
  res.3<-glm.ace.ub(data,"ace_c2","dunedin")
  return(res.3)
})

qhat<-lapply(pa.3, function(re){
  beta<-re$beta[c(2:3,10)]
  names(beta)<-c(">=4 ACEs","Time", ">=4 ACEs:Time")
  return(beta)
})

se<-lapply(pa.3, function(re){
  se<-re$SE[c(2:3,10)]
  names(se)<-c(">=4 ACEs","Time", ">=4 ACEs:Time")
  return(se)
})

pool.3 <- pool_mi( qhat=qhat, se=se )

summary(pool.3)
```
  
```{r}
outcome_list<-c("eaa_grim","eage_grim","dunedin")
result.matrix<-matrix(NA, nrow = 9, ncol = 5)
result.matrix[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))
for (i in 1:3) {
  pa<-lapply(imp_list_new, function(data){
  res<-glm.ace.ub(data,"ace_c2", outcome_list[i])
  return(res)
})

qhat<-lapply(pa, function(re){
  beta<-re$beta[c(2:3,10)]
  names(beta)<-c(">=4 ACEs","Time", ">=4 ACEs:Time")
  return(beta)
})

se<-lapply(pa, function(re){
  se<-re$SE[c(2:3,10)]
  names(se)<-c(">=4 ACEs","Time", ">=4 ACEs:Time")
  return(se)
})

pool.re <- pool_mi( qhat=qhat, se=se )

result.matrix[(3*i-2):(3*i),1]<-summary(pool.re)[["results"]]
result.matrix[(3*i-2):(3*i),2]<-summary(pool.re)[["p"]]
result.matrix[(3*i-2):(3*i),3]<-summary(pool.re)[["(lower"]]
result.matrix[(3*i-2):(3*i),4]<-summary(pool.re)[["upper)"]]

}
colnames(result.matrix)<-c("beta","p-value","lower","upper","outcome")

result.matrix<-as.data.frame(result.matrix)%>%mutate_at(vars(beta:upper), as.numeric)

```


```{r}
result.matrix.1<-matrix(NA, nrow = 9, ncol = 5)
result.matrix.1[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))

for (i in 1:3) {
  pa<-lapply(imp_list_new, function(data){
  res<-glm.ace.ub(data,"ACE_TOT", outcome_list[i])
  return(res)
})

qhat<-lapply(pa, function(re){
  beta<-re$beta[c(2:3,10)]
  names(beta)<-c("ACEs score","Time", "ACEs score:Time")
  return(beta)
})

se<-lapply(pa, function(re){
  se<-re$SE[c(2:3,10)]
  names(se)<-c("ACEs score","Time", "ACEs score:Time")
  return(se)
})

pool.re <- pool_mi( qhat=qhat, se=se )

result.matrix.1[(3*i-2):(3*i),1]<-summary(pool.re)[["results"]]
result.matrix.1[(3*i-2):(3*i),2]<-summary(pool.re)[["p"]]
result.matrix.1[(3*i-2):(3*i),3]<-summary(pool.re)[["(lower"]]
result.matrix.1[(3*i-2):(3*i),4]<-summary(pool.re)[["upper)"]]

}
colnames(result.matrix.1)<-c("beta","p-value","lower","upper","outcome")
result.matrix.1<-as.data.frame(result.matrix.1)%>%mutate_at(vars(beta:upper), as.numeric)
```


```{r}
result.matrix$variable<-factor(rep(c(1, 2, 3),3), levels = c(1,2,3), labels = c("4+ ACEs", "Time", "4+ ACEs*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
result.matrix$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))#c(rep("GrimAA",3),rep("GrimAge",3),rep("DunedinPACE",3))


ana.plot<- ggplot(data=result.matrix,
                          aes(x = variable, y = beta, ymin = lower, ymax = upper))+
  geom_pointrange(aes(col=variable))+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between 4+ ACEs and EAA over Average Six-year Follow-up", col = "Variables")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.1,cex=0.75) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot
```

```{r}
result.matrix.1$variable<-factor(rep(c(1, 2, 3),3), levels = c(1,2,3), labels = c("ACEs score", "Time", "ACEs score*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
result.matrix.1$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))#c(rep("GrimAA",3),rep("GrimAge",3),rep("DunedinPACE",3))


ana.plot.1<- ggplot(data=result.matrix.1,
                          aes(x = variable, y = beta, ymin = lower, ymax = upper))+
  geom_pointrange(aes(col=variable))+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between ACEs Score and EAA over Average Six-year Follow-up", col = "Variables")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.1,cex=0.75) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.1
```


```{r, echo=F}
ana.1.ub<-glm.ace.ub("sol.ana.long.ub", "ace_c2", "eaa_grim") #Binary ACE (<4 vs. >=4) and EAA GrimAge
#ana.1.ub
ana.2.ub<-glm.ace.ub("sol.ana.long.ub", "ace_c2", "eage_grim") #Binary ACE (<4 vs. >=4) and Epigenetic age change using GrimAge
#ana.2.ub
ana.3.ub<-glm.ace.ub("sol.ana.long.ub", "ace_c2", "dunedin") #Binary ACE (<4 vs. >=4) and Epigenetic age Pace
#ana.3.ub
ana.4.ub<-glm.ace.ub("sol.ana.long.ub", "ACE_TOT", "eaa_grim") #Continuous ACE and EAA GrimAge
#ana.4.ub
ana.5.ub<-glm.ace.ub("sol.ana.long.ub", "ACE_TOT", "eage_grim") #Continuous ACE and Epigenetic age change using GrimAge
#ana.5.ub
ana.6.ub<-glm.ace.ub("sol.ana.long.ub", "ACE_TOT", "dunedin") #Continuous ACE and Epigenetic age Pace
#ana.6.ub

summary.1.ub<-result.summary(ana.1.ub, exposure = "ace_c2")
summary.2.ub<-result.summary(ana.2.ub, exposure = "ace_c2")
summary.3.ub<-result.summary(ana.3.ub, exposure = "ace_c2")
summary.4.ub<-result.summary(ana.4.ub, exposure = "ACE_TOT")
summary.5.ub<-result.summary(ana.5.ub, exposure = "ACE_TOT")
summary.6.ub<-result.summary(ana.6.ub, exposure = "ACE_TOT")
```

```{r, echo=F}
test.3<-rbind(summary.1.ub,summary.4.ub,summary.2.ub,
              summary.5.ub,summary.3.ub,summary.6.ub)


kable(test.3, format = "latex", booktabs = T, digits = 3, 
      caption = "Association of ACEs with EAA using different ACEs variables and EAA indicators")%>% 
  add_header_above(c(" " = 1, "GLM" = 4))%>% pack_rows(index = c("GrimAA"=12, "GrimAge"=12,"DunedinPACE"=12))%>%
  pack_rows(index = rep(c("Model 1" = 3, "Model 2" = 3),6))
``` 

### Sensitivity analysis

#### Adjusted for cell types

  - Adjusted for cell types seemed increased the power (many associations turned into statistically significant!!)
  
  - Probably because cell types were associated with the outcome but not the exposure (aka precision variables)

```{r}
glm.ace.cell<-function(data, exposure, outcome) {
  formula.cell<-as.formula(paste(outcome, "~", exposure,"+ age_change + AGE + GENDER + fa_edu_3c + ma_edu_3c + NK + B + MO + GR + CD4 + CD8 + age_change:", exposure))
  model.cell<-lme(formula.cell, 
               data = data,
               random = ~1+age_change|ID,
               weights = varFixed(~WEIGHT_NORM_OVERALL_EPIGEN),
               method = "REML",
               na.action = na.omit)
  #print(summary(model.cell))
  robust.cell<-coef_test(model.cell, vcov = "CR0", test = "z")
  return(robust.cell)
}
```


```{r}
result.matrix.3<-matrix(NA, nrow = 9, ncol = 5)
result.matrix.3[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))

for (i in 1:3) {
  pa<-lapply(imp_list_new, function(data){
  res<-glm.ace.cell(data,"ace_c2", outcome_list[i])
  return(res)
})

qhat<-lapply(pa, function(re){
  beta<-re$beta[c(2:3,16)]
  names(beta)<-c(">=4 ACEs","Time", ">=4 ACEs:Time")
  return(beta)
})

se<-lapply(pa, function(re){
  se<-re$SE[c(2:3,16)]
  names(se)<-c(">=4 ACEs","Time", ">=4 ACEs:Time")
  return(se)
})

pool.re <- pool_mi( qhat=qhat, se=se )

result.matrix.3[(3*i-2):(3*i),1]<-summary(pool.re)[["results"]]
result.matrix.3[(3*i-2):(3*i),2]<-summary(pool.re)[["p"]]
result.matrix.3[(3*i-2):(3*i),3]<-summary(pool.re)[["(lower"]]
result.matrix.3[(3*i-2):(3*i),4]<-summary(pool.re)[["upper)"]]

}
colnames(result.matrix.3)<-c("beta","p-value","lower","upper","outcome")
result.matrix.3<-as.data.frame(result.matrix.3)%>%mutate_at(vars(beta:upper), as.numeric)
```
```{r}
result.matrix.4<-matrix(NA, nrow = 9, ncol = 5)
result.matrix.4[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))

for (i in 1:3) {
  pa<-lapply(imp_list_new, function(data){
  res<-glm.ace.cell(data,"ACE_TOT", outcome_list[i])
  return(res)
})

qhat<-lapply(pa, function(re){
  beta<-re$beta[c(2:3,16)]
  names(beta)<-c("ACEs score","Time", "ACEs score:Time")
  return(beta)
})

se<-lapply(pa, function(re){
  se<-re$SE[c(2:3,16)]
  names(se)<-c("ACEs score","Time", "ACEs score:Time")
  return(se)
})

pool.re <- pool_mi( qhat=qhat, se=se )

result.matrix.4[(3*i-2):(3*i),1]<-summary(pool.re)[["results"]]
result.matrix.4[(3*i-2):(3*i),2]<-summary(pool.re)[["p"]]
result.matrix.4[(3*i-2):(3*i),3]<-summary(pool.re)[["(lower"]]
result.matrix.4[(3*i-2):(3*i),4]<-summary(pool.re)[["upper)"]]

}
colnames(result.matrix.4)<-c("beta","p-value","lower","upper","outcome")
result.matrix.4<-as.data.frame(result.matrix.4)%>%mutate_at(vars(beta:upper), as.numeric)
```

```{r}
result.matrix.3$variable<-factor(rep(c(1, 2, 3),3), levels = c(1,2,3), labels = c("4+ ACEs", "Time", "4+ ACEs*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
result.matrix.3$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))#c(rep("GrimAA",3),rep("GrimAge",3),rep("DunedinPACE",3))


ana.plot.3<- ggplot(data=result.matrix.3,
                          aes(x = variable, y = beta, ymin = lower, ymax = upper))+
  geom_pointrange(aes(col=variable))+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between 4+ ACEs and EAA over Average Six-year Follow-up Adjusting for Cell Types", col = "Variables")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.1,cex=0.75) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.3
```

```{r}
result.matrix.cell<-rbind(result.matrix,result.matrix.3)
result.matrix.cell$model<-factor(c(rep(1,9),rep(2,9)), levels = c(1,2), labels = c("Model 1", "Model 1 + Cell types"))
result.matrix.cell$position<-factor(c(rep(c(1,3,5),3),rep(c(2,4,6),3)))



ana.plot.cell<- ggplot(data=result.matrix.cell,
                          aes(x = position, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable, shape=model), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between 4+ ACEs and EAA over Average Six-year Follow-up", col = "Variables", shape = "Model")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.cell
```

```{r}
result.matrix.4$variable<-factor(rep(c(1, 2, 3),3), levels = c(1,2,3), labels = c("ACEs score", "Time", "ACEs score*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
result.matrix.4$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))
result.matrix.cell.1<-rbind(result.matrix.1,result.matrix.4)
result.matrix.cell.1$model<-factor(c(rep(1,9),rep(2,9)), levels = c(1,2), labels = c("Model 1", "Model 1 + Cell types"))
result.matrix.cell.1$position<-factor(c(rep(c(1,3,5),3),rep(c(2,4,6),3)))



ana.plot.cell.1<- ggplot(data=result.matrix.cell.1,
                          aes(x = position, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable, shape=model), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between ACEs Score and EAA over Average Six-year Follow-up", col = "Variables", shape = "Model")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.cell.1
```




#### Parental separate as the covariate

```{r}
### Parental separate as the covariate
glm.ace.nd<-function(data, exposure, outcome) {
  
  formula_1<-as.formula(paste(outcome, "~", exposure,"+ age_change + AGE + GENDER + fa_edu_3c + ma_edu_3c + STEA16 + age_change:", exposure))
  model.1<-lme(formula_1, 
               data = data,
               random = ~1+age_change|ID,
               weights = varFixed(~WEIGHT_NORM_OVERALL_EPIGEN),
               method = "REML",
               na.action = na.omit)
  #print(summary(model.1))
  robust.1<-coef_test(model.1, vcov = "CR0", test = "z")
  
  return(robust.1)
}
```


```{r}
result.matrix.5<-matrix(NA, nrow = 9, ncol = 5)
result.matrix.5[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))

for (i in 1:3) {
  pa<-lapply(imp_list_new, function(data){
  res<-glm.ace.nd(data,"ace_c2_ND", outcome_list[i])
  return(res)
})

qhat<-lapply(pa, function(re){
  beta<-re$beta[c(2:3,11)]
  names(beta)<-c(">=4 ACEs","Time", ">=4 ACEs:Time")
  return(beta)
})

se<-lapply(pa, function(re){
  se<-re$SE[c(2:3,11)]
  names(se)<-c(">=4 ACEs","Time", ">=4 ACEs:Time")
  return(se)
})

pool.re <- pool_mi( qhat=qhat, se=se )

result.matrix.5[(3*i-2):(3*i),1]<-summary(pool.re)[["results"]]
result.matrix.5[(3*i-2):(3*i),2]<-summary(pool.re)[["p"]]
result.matrix.5[(3*i-2):(3*i),3]<-summary(pool.re)[["(lower"]]
result.matrix.5[(3*i-2):(3*i),4]<-summary(pool.re)[["upper)"]]

}
colnames(result.matrix.5)<-c("beta","p-value","lower","upper","outcome")
result.matrix.5<-as.data.frame(result.matrix.5)%>%mutate_at(vars(beta:upper), as.numeric)
```

```{r}
result.matrix.6<-matrix(NA, nrow = 9, ncol = 5)
result.matrix.6[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))

for (i in 1:3) {
  pa<-lapply(imp_list_new, function(data){
  res<-glm.ace.nd(data,"ACE_TOT_ND", outcome_list[i])
  return(res)
})

qhat<-lapply(pa, function(re){
  beta<-re$beta[c(2:3,11)]
  names(beta)<-c("ACEs score","Time", "ACEs score:Time")
  return(beta)
})

se<-lapply(pa, function(re){
  se<-re$SE[c(2:3,11)]
  names(se)<-c("ACEs score","Time", "ACEs score:Time")
  return(se)
})

pool.re <- pool_mi( qhat=qhat, se=se )

result.matrix.6[(3*i-2):(3*i),1]<-summary(pool.re)[["results"]]
result.matrix.6[(3*i-2):(3*i),2]<-summary(pool.re)[["p"]]
result.matrix.6[(3*i-2):(3*i),3]<-summary(pool.re)[["(lower"]]
result.matrix.6[(3*i-2):(3*i),4]<-summary(pool.re)[["upper)"]]

}
colnames(result.matrix.6)<-c("beta","p-value","lower","upper","outcome")
result.matrix.6<-as.data.frame(result.matrix.6)%>%mutate_at(vars(beta:upper), as.numeric)
```
```{r}
result.matrix.5$variable<-factor(rep(c(1, 2, 3),3), levels = c(1,2,3), labels = c("4+ ACEs", "Time", "4+ ACEs*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
result.matrix.5$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

result.matrix.nd<-rbind(result.matrix,result.matrix.5)
result.matrix.nd$model<-factor(c(rep(1,9),rep(2,9)), levels = c(1,2), labels = c("Parental separation as an ACE", "Parental separation as a covariate"))
result.matrix.nd$position<-factor(c(rep(c(1,3,5),3),rep(c(2,4,6),3)))



ana.plot.nd<- ggplot(data=result.matrix.nd,
                          aes(x = position, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable, shape = model), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between 4+ ACEs and EAA over Average Six-year Follow-up", col = "Variables", shape = "Model")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.nd
```

```{r}
result.matrix.6$variable<-factor(rep(c(1, 2, 3),3), levels = c(1,2,3), labels = c("ACEs score", "Time", "ACEs score*Time"))#rep(c("4+ ACEs", "Time", "4+ ACEs*Time"),3)
result.matrix.6$outcome<-factor(c(rep(1,3),rep(2,3),rep(3,3)), levels = c(1,2,3), labels = c("GrimAA","GrimAge","DunedinPACE"))

result.matrix.nd.1<-rbind(result.matrix.1,result.matrix.6)
result.matrix.nd.1$model<-factor(c(rep(1,9),rep(2,9)), levels = c(1,2), labels = c("Parental separation as an ACE", "Parental separation as a covariate"))
result.matrix.nd.1$position<-factor(c(rep(c(1,3,5),3),rep(c(2,4,6),3)))



ana.plot.nd.1<- ggplot(data=result.matrix.nd.1,
                          aes(x = position, y = beta, ymin = lower, ymax = upper))+
  geom_point(aes(col=variable, shape = model), size = 2)+
  geom_hline(yintercept =0, linetype=2)+
  ylab("Coefficient (95% CI)")+
  labs(title = "Association between ACEs Score and EAA over Average Six-year Follow-up", col = "Variables", shape = "Model")+
  geom_errorbar(aes(ymin=lower, ymax=upper,col=variable),width=0.2,cex=0.5) +
  facet_wrap(~outcome,strip.position="left",nrow=3,scales = "free_y")+theme_bw()+
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ana.plot.nd.1
```



```{r, echo=F}
test.1<-rbind(summary.1.ml.cell,
            summary.4.ml.cell,
            summary.2.ml.cell,
            summary.5.ml.cell,
            summary.3.ml.cell,
            summary.6.ml.cell)

kable(test.1, format = "latex", booktabs = T, digits = 3, 
      caption = "Sensitivity Analysis by Adjusting for Cell Types")%>% 
  add_header_above(c(" " = 1, "GLM" = 4))%>% 
  pack_rows(index = c("GrimAA"=6, "GrimAge"=6,"DunedinPACE"=6))%>%
  pack_rows(index = rep(c("Model 2 + cell types" = 3),6))
```

#### Using three-level ACEs

  - When changing the reference group from "<4 ACEs" to "No ACE", the association was better revealed in **GrimAA** and **GrimAge**, but not **DunedinPACE**
  
    - Results were consistent with models using ACEs scores
  
  - There is some evidence that even small number of ACEs can associated with EAA
  
  - Maybe consider it the primary exposure variable?

```{r}
result.matrix.2<-matrix(NA, nrow = 15, ncol = 5)
result.matrix.2[,5]<-c(rep("eaa_grim",5),rep("eage_grim",5),rep("dunedin",5))

for (i in 1:3) {
  pa<-lapply(imp_list_new, function(data){
  res<-glm.ace.ub(data,"ace_c3", outcome_list[i])
  return(res)
})

qhat<-lapply(pa, function(re){
  beta<-re$beta[c(2:4,11:12)]
  names(beta)<-c("1-3 ACEs",">=4 ACEs","Time", "1-3 ACEs:Time", ">=4 ACEs:Time")
  return(beta)
})

se<-lapply(pa, function(re){
  se<-re$SE[c(2:4,11:12)]
  names(se)<-c("1-3 ACEs",">=4 ACEs","Time", "1-3 ACEs:Time", ">=4 ACEs:Time")
  return(se)
})

pool.re <- pool_mi( qhat=qhat, se=se )

result.matrix.2[(5*i-4):(5*i),1]<-summary(pool.re)[["results"]]
result.matrix.2[(5*i-4):(5*i),2]<-summary(pool.re)[["p"]]
result.matrix.2[(5*i-4):(5*i),3]<-summary(pool.re)[["(lower"]]
result.matrix.2[(5*i-4):(5*i),4]<-summary(pool.re)[["upper)"]]

}
colnames(result.matrix.2)<-c("beta","p-value","lower","upper","outcome")
result.matrix.2<-as.data.frame(result.matrix.2)%>%mutate_at(vars(beta:upper), as.numeric)
```

```{r, echo=F}
#### GLM
ana.1.ml.4c<-glm.ace.ub("sol.ana.long.ub", "ace_c4", "eaa_grim") # EAA GrimAge
#ana.1.ml.4c

ana.2.ml.4c<-glm.ace.ub("sol.ana.long.ub", "ace_c4", "eage_grim") #Epigenetic age change using GrimAge
#ana.2.ml.4c

ana.3.ml.4c<-glm.ace.ub("sol.ana.long.ub", "ace_c4", "dunedin") # Epigenetic age Pace
#ana.3.ml.4c

summary.1.4c.ml<-result.summary(ana.1.ml.4c, "ace_c4")
summary.2.4c.ml<-result.summary(ana.2.ml.4c, "ace_c4")
summary.3.4c.ml<-result.summary(ana.3.ml.4c, "ace_c4")
```

```{r, echo=F}
test.2<-rbind(summary.1.4c.ml,
             summary.2.4c.ml,
             summary.3.4c.ml)

kable(test.2, format = "latex", booktabs = T, digits = 3, caption = "Sensitivity Analaysis by Using Three-levels ACEs")%>% add_header_above(c(" " = 1, "GLM" = 4))%>% pack_rows(index = c("GrimAA"=10, "GrimAge"=10,"DunedinPACE"=10))%>%
  pack_rows(index = rep(c("Model 1" = 5, "Model 2" = 5),3))
```


#### Association for each adverse experience 

  - Physical abuse + Sexual Abuse + Emotional Neglect + Parental separate + Intimate partner violence + Mental illness among family members + in prison
  
  - All above showed non-negligible effect sizes (not all of them are statistically significant)


```{r}
ace_specific<-lapply(ace.2, function(x){
  result.matrix.x<-matrix(NA, nrow = 9, ncol = 5)
  result.matrix.x[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))
  
  for (i in 1:3) {
    pa<-lapply(imp_list_new, function(data){
    res<-glm.ace.ub(data,x, outcome_list[i])
    return(res)
  })

  qhat<-lapply(pa, function(re){
    beta<-re$beta[c(2:3,10)]
    names(beta)<-c("ACE","Time", "ACE:Time")
    return(beta)
  })

  se<-lapply(pa, function(re){
    se<-re$SE[c(2:3,10)]
    names(se)<-c("ACE","Time", "ACE:Time")
    return(se)
  })

  pool.re <- pool_mi( qhat=qhat, se=se )

  result.matrix.x[(3*i-2):(3*i),1]<-summary(pool.re)[["results"]]
  result.matrix.x[(3*i-2):(3*i),2]<-summary(pool.re)[["p"]]
  result.matrix.x[(3*i-2):(3*i),3]<-summary(pool.re)[["(lower"]]
  result.matrix.x[(3*i-2):(3*i),4]<-summary(pool.re)[["upper)"]]

  }
  colnames(result.matrix.x)<-c("beta","p-value","lower","upper","outcome")
  result.matrix.x<-as.data.frame(result.matrix.x)%>%mutate_at(vars(beta:upper), as.numeric)
  return(result.matrix.x)
})
```

#### Adjust for ancestry

  - Only 774 subjects had the ancestry information
  
  - Also seemed to improve the power (p-value decreased for ACE-EAA associations)

```{r, echo=F}
colnames(sol.ac.pc)[1]<-"ID"
#sol.ac.pc.long<-rbind(sol.ac.pc,sol.ac.pc)
#sol.ac.pc.long<-sol.ac.pc.long[order(sol.ac.pc.long$ID),]
#sol.ana.ac<-merge(sol.ana.1,sol.ac.pc, by = "ID")
imp_list_ac<-lapply(imp_list_new, function(data){
  data<-merge(data,sol.ac.pc, by = "ID")
  return(data)
})


```


```{r}
# Consistency between baseline age and age at first epigenetic age measurement
summary(sol.ana.ac$age_v1-sol.ana.ac$AGE)
# Interval between first and second measurement
table(sol.ana.ac$age_v2-sol.ana.ac$AGE)
# Subjects that had the interval <3 or >9
sol.ana.ac$ID[which((sol.ana.ac$age_v2-sol.ana.ac$AGE<3|sol.ana.ac$age_v2-sol.ana.ac$AGE>9))]
outlier_ID_ac<-sol.ana.ac$ID[which((sol.ana.ac$age_v2-sol.ana.ac$AGE<3|sol.ana.ac$age_v2-sol.ana.ac$AGE>9))]

# Exclude the outlier
sol.ana.long.ac.ub<-sol.ana.long.ac%>%filter(!ID%in%outlier_ID_ac)
```


```{r}
#### GLM
glm.ace.ac<-function(data, exposure, outcome) {
  formula.ac<-as.formula(paste(outcome, "~", exposure,"+ age_change + AGE + GENDER + fa_edu_3c + ma_edu_3c + EV1 + EV2 + EV3 + EV4 + EV5 + age_change:", exposure))
  model.ac<-lme(formula.ac, 
                  data = data,
                  random = ~1+age_change|ID,
                  weights = varFixed(~WEIGHT_NORM_OVERALL_EPIGEN),
                  method = "REML",
                  na.action = na.omit)
  #print(summary(model.ac))
  robust.ac<-coef_test(model.ac, vcov = "CR0", test = "z")
  return(robust.ac)
}
```


```{r}
ace_list<-c("ace_c2","ACE_TOT")

ace_ancestry<-lapply(ace_list, function(x){
  result.matrix.x<-matrix(NA, nrow = 9, ncol = 5)
  result.matrix.x[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))
  
  for (i in 1:3) {
    pa<-lapply(imp_list_ac, function(data){
    res<-glm.ace.ac(data,x, outcome_list[i])
    return(res)
  })

  qhat<-lapply(pa, function(re){
    beta<-re$beta[c(2:3,15)]
    names(beta)<-c("ACE","Time", "ACE:Time")
    return(beta)
  })

  se<-lapply(pa, function(re){
    se<-re$SE[c(2:3,15)]
    names(se)<-c("ACE","Time", "ACE:Time")
    return(se)
  })

  pool.re <- pool_mi( qhat=qhat, se=se )

  result.matrix.x[(3*i-2):(3*i),1]<-summary(pool.re)[["results"]]
  result.matrix.x[(3*i-2):(3*i),2]<-summary(pool.re)[["p"]]
  result.matrix.x[(3*i-2):(3*i),3]<-summary(pool.re)[["(lower"]]
  result.matrix.x[(3*i-2):(3*i),4]<-summary(pool.re)[["upper)"]]

  }
  colnames(result.matrix.x)<-c("beta","p-value","lower","upper","outcome")
  result.matrix.x<-as.data.frame(result.matrix.x)%>%mutate_at(vars(beta:upper), as.numeric)
  return(result.matrix.x)
})

```

#### Complete case analysis

  - Evidence that not dealing with missing value may lead to overestimated results.

```{r}
sol.ana.long.cca<-sol.ana.long[complete.cases(sol.ana.long[,c("ACE_TOT","fa_edu_3c","ma_edu_3c","GENDER","AGE")]),]
sol.ana.long.cca<-sol.ana.long.cca%>%mutate(ace_c2=ifelse(ACE_TOT<4,0,1))

cca.list<-lapply(ace_list,function(x) {
   result.matrix.x<-matrix(NA, nrow = 9, ncol = 5)
   result.matrix.x[,5]<-c(rep("eaa_grim",3),rep("eage_grim",3),rep("dunedin",3))
   for (i in 1:3) {
     res<-glm.ace.ub(sol.ana.long.cca,x,outcome_list[i])
     res<-res[c(2:3,10),]
     result.matrix.x[(3*i-2):(3*i),1]<-res$beta
     result.matrix.x[(3*i-2):(3*i),2]<-res$p_z
     result.matrix.x[(3*i-2):(3*i),3]<-res$beta - 1.96*res$SE
     result.matrix.x[(3*i-2):(3*i),4]<-res$beta + 1.96*res$SE
   }
   colnames(result.matrix.x)<-c("beta","p-value","lower","upper","outcome")
   result.matrix.x<-as.data.frame(result.matrix.x)%>%mutate_at(vars(beta:upper), as.numeric)
   return(result.matrix.x)
})

```



```{r, echo=F}
ana.1.ac<-glm.ace.ac("sol.ana.long.ac.ub", "ace_c2", "eaa_grim") #Binary ACE (<4 vs. >=4) and EAA GrimAge
#ana.1.ac
ana.2.ac<-glm.ace.ac("sol.ana.long.ac.ub", "ace_c2", "eage_grim") #Binary ACE (<4 vs. >=4) and Epigenetic age change using GrimAge
#ana.2.ac

ana.3.ac<-glm.ace.ac("sol.ana.long.ac.ub", "ace_c2", "dunedin") #Binary ACE (<4 vs. >=4) and Epigenetic age Pace
#ana.3.ac
ana.4.ac<-glm.ace.ac("sol.ana.long.ac.ub", "ACE_TOT", "eaa_grim") #Continuous ACE and EAA GrimAge
#ana.4.ac
ana.5.ac<-glm.ace.ac("sol.ana.long.ac.ub", "ACE_TOT", "eage_grim") #Continuous ACE and Epigenetic age change using GrimAge
#ana.5.ac
ana.6.ac<-glm.ace.ac("sol.ana.long.ac.ub", "ACE_TOT", "dunedin") #Continuous ACE and Epigenetic age Pace
#ana.6.ac

summary.1.ml.ac<-result.summary(ana.1.ac, "ace_c2", "ancenstry")
summary.2.ml.ac<-result.summary(ana.2.ac, "ace_c2", "ancenstry")
summary.3.ml.ac<-result.summary(ana.3.ac, "ace_c2", "ancenstry")
summary.4.ml.ac<-result.summary(ana.4.ac, "ACE_TOT", "ancenstry")
summary.5.ml.ac<-result.summary(ana.5.ac, "ACE_TOT", "ancenstry")
summary.6.ml.ac<-result.summary(ana.6.ac, "ACE_TOT", "ancenstry")
```

```{r, echo=F}
test.4<-rbind(summary.1.ml.ac,
              summary.4.ml.ac,
              summary.2.ml.ac,
              summary.5.ml.ac,
              summary.3.ml.ac,
              summary.6.ml.ac)

kable(test.4, format = "latex", booktabs = T, digits = 3, caption = "Sensitivity Analysis by Adjusting for Ancestry")%>% add_header_above(c(" " = 1, "GLM" = 4))%>% pack_rows(index = c("GrimAA"=6, "GrimAge"=6,"DunedinPACE"=6))%>%
  pack_rows(index = rep(c( "Model 2 + ancenstry" = 3),6))
```
